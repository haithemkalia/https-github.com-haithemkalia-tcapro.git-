{% extends "base.html" %}
{% block title %}ุงูุฑุฆูุณูุฉ - {{ app_title }}{% endblock %}
{% block content %}
<div class="container-fluid">
 <!-- En-tรชte du tableau de bord -->
 <div class="row mb-4">
  <div class="col-12">
   <div class="card card-modern">
    <div class="card-header-modern">
     <div class="row align-items-center">
      <div class="col">
       <h2 class="mb-0">
        <i class="fas fa-tachometer-alt me-2"></i> ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ
       </h2>
       <p class="mb-0 mt-2 opacity-75">ูุธุฑุฉ ุดุงููุฉ ุนูู ุญุงูุฉ ุทูุจุงุช ุงูุชุฃุดูุฑุงุช</p>
      </div>
      <div class="col-auto">
       <div class="text-end">
        <small class="opacity-75">ุขุฎุฑ ุชุญุฏูุซ: {{ current_datetime }}</small>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>

 <!-- Statistiques principales - Calculรฉes prรฉcisรฉment -->
 <div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card">
    <div class="stats-number">{{ stats.total_clients or 0 }}</div>
    <div class="stats-label">
     <i class="fas fa-users me-1"></i> ุฅุฌูุงูู ุงูุนููุงุก
    </div>
    <div class="stats-detail">
     <small class="text-muted">ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุงููุฉ</small>
    </div>
   </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
    <div class="stats-number">{{ stats.by_status.get('ุงูุชููุช ุงูุนูููุฉ', 0) }}</div>
    <div class="stats-label">
     <i class="fas fa-check-circle me-1"></i> ุงูุนูููุงุช ุงูููุชููุฉ
    </div>
    <div class="stats-detail">
     <small class="text-white-50">ููุชููุฉ ุจุงููุงูู</small>
    </div>
   </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
    <div class="stats-number">{{ stats.by_status.get('ุชูุช ุงูููุงููุฉ ุนูู ุงูุชุฃุดูุฑุฉ', 0) }}</div>
    <div class="stats-label">
     <i class="fas fa-passport me-1"></i> ุงูุชุฃุดูุฑุงุช ุงููุนุชูุฏุฉ
    </div>
    <div class="stats-detail">
     <small class="text-white-50">ูุนุชูุฏุฉ ูู ุงูุณูุงุฑุฉ</small>
    </div>
   </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
    <div class="stats-number">{{ stats.by_status.get('ุชู ุงูุชูุฏูู ูู ุงูุณูุณุชุงู', 0) }}</div>
    <div class="stats-label">
     <i class="fas fa-file-alt me-1"></i> ุทูุจุงุช ุฌุฏูุฏุฉ
    </div>
    <div class="stats-detail">
     <small class="text-white-50">ูู ุงููุธุงู</small>
    </div>
   </div>
  </div>
 </div>

 <!-- Graphiques et distributions -->
 <div class="row">
  <!-- Distribution des statuts de visa - Dรฉtails complets -->
  <div class="col-lg-6 mb-4">
   <div class="card card-modern h-100">
    <div class="card-header-modern">
     <h5 class="mb-0">
      <i class="fas fa-chart-pie me-2"></i> ุชูุฒูุน ุญุงูุงุช ุงูุชุฃุดูุฑุงุช
     </h5>
     <small class="text-muted">ุฅุญุตุงุฆูุงุช ุฏูููุฉ ูู {{ stats.total_clients or 0 }} ุนููู</small>
    </div>
    <div class="card-body">
     <div class="row">
      <!-- ุงูุชููุช ุงูุนูููุฉ -->
      <div class="col-6 text-center mb-3">
       <div class="p-3 rounded" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <h4 class="mb-1">{{ stats.by_status.get('ุงูุชููุช ุงูุนูููุฉ', 0) }}</h4>
        <small>ุงูุชููุช ุงูุนูููุฉ</small>
        {% if stats.total_clients > 0 %}
        <div class="mt-2">
         <small class="opacity-75">{{ "%.1f"|format((stats.by_status.get('ุงูุชููุช ุงูุนูููุฉ', 0) / stats.total_clients * 100)) }}%</small>
        </div>
        {% endif %}
       </div>
      </div>
      
      <!-- ุชูุช ุงูููุงููุฉ ุนูู ุงูุชุฃุดูุฑุฉ -->
      <div class="col-6 text-center mb-3">
       <div class="p-3 rounded" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white;">
        <h4 class="mb-1">{{ stats.by_status.get('ุชูุช ุงูููุงููุฉ ุนูู ุงูุชุฃุดูุฑุฉ', 0) }}</h4>
        <small>ุชูุช ุงูููุงููุฉ ุนูู ุงูุชุฃุดูุฑุฉ</small>
        {% if stats.total_clients > 0 %}
        <div class="mt-2">
         <small class="opacity-75">{{ "%.1f"|format((stats.by_status.get('ุชูุช ุงูููุงููุฉ ุนูู ุงูุชุฃุดูุฑุฉ', 0) / stats.total_clients * 100)) }}%</small>
        </div>
        {% endif %}
       </div>
      </div>
      
      <!-- ุงูุชุฃุดูุฑุฉ ุบูุฑ ููุงูู ุนูููุง -->
      <div class="col-6 text-center mb-3">
       <div class="p-3 rounded" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white;">
        <h4 class="mb-1">{{ stats.by_status.get('ุงูุชุฃุดูุฑุฉ ุบูุฑ ููุงูู ุนูููุง', 0) }}</h4>
        <small>ุงูุชุฃุดูุฑุฉ ุบูุฑ ููุงูู ุนูููุง</small>
        {% if stats.total_clients > 0 %}
        <div class="mt-2">
         <small class="opacity-75">{{ "%.1f"|format((stats.by_status.get('ุงูุชุฃุดูุฑุฉ ุบูุฑ ููุงูู ุนูููุง', 0) / stats.total_clients * 100)) }}%</small>
        </div>
        {% endif %}
       </div>
      </div>
      
      <!-- ุชู ุงูุชูุฏูู ูู ุงูุณูุณุชุงู -->
      <div class="col-6 text-center mb-3">
       <div class="p-3 rounded" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%); color: white;">
        <h4 class="mb-1">{{ stats.by_status.get('ุชู ุงูุชูุฏูู ูู ุงูุณูุณุชุงู', 0) }}</h4>
        <small>ุชู ุงูุชูุฏูู ูู ุงูุณูุณุชุงู</small>
        {% if stats.total_clients > 0 %}
        <div class="mt-2">
         <small class="opacity-75">{{ "%.1f"|format((stats.by_status.get('ุชู ุงูุชูุฏูู ูู ุงูุณูุณุชุงู', 0) / stats.total_clients * 100)) }}%</small>
        </div>
        {% endif %}
       </div>
      </div>
      
      <!-- ุชู ุงูุชูุฏูู ุฅูู ุงูุณูุงุฑุฉ -->
      <div class="col-12 text-center mb-3">
       <div class="p-3 rounded" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white;">
        <h4 class="mb-1">{{ stats.by_status.get('ุชู ุงูุชูุฏูู ุฅูู ุงูุณูุงุฑุฉ', 0) }}</h4>
        <small>ุชู ุงูุชูุฏูู ุฅูู ุงูุณูุงุฑุฉ</small>
        {% if stats.total_clients > 0 %}
        <div class="mt-2">
         <small class="opacity-75">{{ "%.1f"|format((stats.by_status.get('ุชู ุงูุชูุฏูู ุฅูู ุงูุณูุงุฑุฉ', 0) / stats.total_clients * 100)) }}%</small>
        </div>
        {% endif %}
       </div>
      </div>
     </div>
     
     <!-- Rรฉsumรฉ des statistiques -->
     <div class="mt-3 p-3 bg-light rounded">
      <h6 class="mb-2">๐ ููุฎุต ุงูุฅุญุตุงุฆูุงุช:</h6>
      <div class="row text-center">
       <div class="col-4">
        <strong class="text-success">{{ stats.by_status.get('ุงูุชููุช ุงูุนูููุฉ', 0) + stats.by_status.get('ุชูุช ุงูููุงููุฉ ุนูู ุงูุชุฃุดูุฑุฉ', 0) }}</strong>
        <br><small class="text-muted">ุฅุฌูุงูู ุงูููุชููุฉ</small>
       </div>
       <div class="col-4">
        <strong class="text-warning">{{ stats.by_status.get('ุงูุชุฃุดูุฑุฉ ุบูุฑ ููุงูู ุนูููุง', 0) }}</strong>
        <br><small class="text-muted">ุบูุฑ ูุนุชูุฏุฉ</small>
       </div>
       <div class="col-4">
        <strong class="text-info">{{ stats.by_status.get('ุชู ุงูุชูุฏูู ูู ุงูุณูุณุชุงู', 0) + stats.by_status.get('ุชู ุงูุชูุฏูู ุฅูู ุงูุณูุงุฑุฉ', 0) }}</strong>
        <br><small class="text-muted">ููุฏ ุงููุนุงูุฌุฉ</small>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>

  <!-- Distribution des nationalitรฉs - Dรฉtails complets -->
  <div class="col-lg-6 mb-4">
   <div class="card card-modern h-100">
    <div class="card-header-modern">
     <h5 class="mb-0">
      <i class="fas fa-globe me-2"></i> ุชูุฒูุน ุงูุฌูุณูุงุช
     </h5>
     <small class="text-muted">ุฌููุน ุงูุฌูุณูุงุช ูู {{ stats.total_clients or 0 }} ุนููู</small>
    </div>
    <div class="card-body">
     <div class="row">
      {% for nationality, count in stats.by_nationality.items() %}
      {% if count > 0 %}
      <div class="col-6 text-center mb-3">
       <div class="p-3 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h4 class="mb-1">{{ count }}</h4>
        <small>{{ nationality }}</small>
        {% if stats.total_clients > 0 %}
        <div class="mt-2">
         <small class="opacity-75">{{ "%.1f"|format((count / stats.total_clients * 100)) }}%</small>
        </div>
        {% endif %}
       </div>
      </div>
      {% endif %}
      {% endfor %}
     </div>
     
     <!-- Rรฉsumรฉ des nationalitรฉs -->
     <div class="mt-3 p-3 bg-light rounded">
      <h6 class="mb-2">๐ ููุฎุต ุงูุฌูุณูุงุช:</h6>
      <div class="row text-center">
       {% set total_with_nationality = stats.by_nationality.values() | sum %}
       <div class="col-6">
        <strong class="text-primary">{{ total_with_nationality }}</strong>
        <br><small class="text-muted">ูุน ุฌูุณูุฉ ูุญุฏุฏุฉ</small>
       </div>
       <div class="col-6">
        <strong class="text-secondary">{{ stats.total_clients - total_with_nationality }}</strong>
        <br><small class="text-muted">ุจุฏูู ุฌูุณูุฉ</small>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>

 <!-- Clients rรฉcents et statistiques des employรฉs -->
 <div class="row">
  <!-- Clients rรฉcents -->
  <div class="col-lg-8 mb-4">
   <div class="card card-modern">
    <div class="card-header-modern">
     <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
       <i class="fas fa-clock me-2"></i> ุงูุนููุงุก ุงูุฌุฏุฏ
      </h5>
      <a href="{{ url_for('clients_list') }}" class="btn btn-light btn-sm"> ุนุฑุถ ุงููู <i class="fas fa-arrow-left ms-1"></i> </a>
     </div>
    </div>
    <div class="card-body">
     {% if stats.recent_clients %}
     <div class="table-responsive">
      <table class="table table-hover">
       <thead class="table-light">
        <tr>
         <th>ุงูุงุณู ุงููุงูู</th>
         <th>ุงูุฌูุณูุฉ</th>
         <th>ุญุงูุฉ ุงูุชุฃุดูุฑุฉ</th>
         <th>ุงูููุธู ุงููุณุคูู</th>
         <th>ุชุงุฑูุฎ ุงูุฅุถุงูุฉ</th>
        </tr>
       </thead>
       <tbody>
        {% for client in stats.recent_clients %}
        <tr>
         <td>
          <strong>{{ client.full_name }}</strong>
          <br><small class="text-muted">{{ client.client_id }}</small>
         </td>
         <td>
          <span class="badge bg-secondary">{{ client.nationality or 'ุบูุฑ ูุญุฏุฏ' }}</span>
         </td>
         <td>
          <span class="status-badge status-{{ (client.visa_status or 'ุบูุฑ ูุญุฏุฏ').replace(' ', '-') }}">
           {{ client.visa_status or 'ุบูุฑ ูุญุฏุฏ' }}
          </span>
         </td>
         <td>{{ client.responsible_employee or 'ุบูุฑ ูุญุฏุฏ' }}</td>
         <td>
          <small>{{ client.created_at[:10] if client.created_at else 'ุบูุฑ ูุญุฏุฏ' }}</small>
         </td>
        </tr>
        {% endfor %}
       </tbody>
      </table>
     </div>
     {% else %}
     <div class="text-center py-4">
      <i class="fas fa-users fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">ูุง ุชูุฌุฏ ุจูุงูุงุช ุนููุงุก</h5>
      <p class="text-muted">ุงุจุฏุฃ ุจุฅุถุงูุฉ ุนููุงุก ุฌุฏุฏ ูุนุฑุถ ุงูุจูุงูุงุช ููุง</p>
      <a href="{{ url_for('add_client') }}" class="btn btn-primary-custom">
       <i class="fas fa-plus me-2"></i>ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
      </a>
     </div>
     {% endif %}
    </div>
   </div>
  </div>

  <!-- Statistiques des employรฉs - Dรฉtails complets -->
  <div class="col-lg-4 mb-4">
   <div class="card card-modern">
    <div class="card-header-modern">
     <h5 class="mb-0">
      <i class="fas fa-user-tie me-2"></i> ุฅุญุตุงุฆูุงุช ุงูููุธููู
     </h5>
     <small class="text-muted">ุชูุฒูุน ุงูุนููุงุก ุญุณุจ ุงูููุธู ุงููุณุคูู</small>
    </div>
    <div class="card-body">
     {% for employee, count in stats.by_employee.items() %}
     {% if count > 0 %}
     <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
       <strong>{{ employee }}</strong>
       {% if stats.total_clients > 0 %}
       <br><small class="text-muted">{{ "%.1f"|format((count / stats.total_clients * 100)) }}%</small>
       {% endif %}
      </div>
      <div>
       <span class="badge bg-primary rounded-pill">{{ count }}</span>
      </div>
     </div>
     <div class="progress mb-3" style="height: 8px;">
      <div class="progress-bar" role="progressbar" 
           style="width: {{ (count / stats.total_clients * 100) if stats.total_clients > 0 else 0 }}%" 
           aria-valuenow="{{ count }}" aria-valuemin="0" aria-valuemax="{{ stats.total_clients }}">
      </div>
     </div>
     {% endif %}
     {% endfor %}
     
     <!-- Rรฉsumรฉ des employรฉs -->
     <div class="mt-3 p-3 bg-light rounded">
      <h6 class="mb-2">๐ฅ ููุฎุต ุงูููุธููู:</h6>
      {% set total_with_employee = stats.by_employee.values() | sum %}
      <div class="row text-center">
       <div class="col-6">
        <strong class="text-primary">{{ total_with_employee }}</strong>
        <br><small class="text-muted">ูุน ููุธู ูุณุคูู</small>
       </div>
       <div class="col-6">
        <strong class="text-secondary">{{ stats.total_clients - total_with_employee }}</strong>
        <br><small class="text-muted">ุจุฏูู ููุธู ูุณุคูู</small>
       </div>
      </div>
      
      <!-- Top employรฉ -->
      {% set top_employee = stats.by_employee.items() | sort(attribute=1, reverse=true) | first %}
      {% if top_employee and top_employee[1] > 0 %}
      <div class="mt-2 text-center">
       <small class="text-success">
        <i class="fas fa-crown me-1"></i>
        ุงูุฃุนูู: {{ top_employee[0] }} ({{ top_employee[1] }} ุนููู)
       </small>
      </div>
      {% endif %}
     </div>
    </div>
   </div>
  </div>
 </div>

 <!-- Actions rapides -->
 <div class="row">
  <div class="col-12">
   <div class="card card-modern">
    <div class="card-header-modern">
     <h5 class="mb-0">
      <i class="fas fa-bolt me-2"></i> ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ
     </h5>
    </div>
    <div class="card-body">
     <div class="row">
      <div class="col-lg-3 col-md-6 mb-3">
       <a href="{{ url_for('add_client') }}" class="btn btn-success-custom w-100 h-100 d-flex flex-column justify-content-center align-items-center p-4">
        <i class="fas fa-user-plus fa-2x mb-2"></i>
        <strong>ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ</strong>
        <small class="mt-1">ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ ูููุธุงู</small>
       </a>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
       <a href="{{ url_for('import_excel') }}" class="btn btn-primary-custom w-100 h-100 d-flex flex-column justify-content-center align-items-center p-4">
        <i class="fas fa-file-excel fa-2x mb-2"></i>
        <strong>ุงุณุชูุฑุงุฏ Excel</strong>
        <small class="mt-1">ุงุณุชูุฑุงุฏ ุนููุงุก ูู ููู Excel</small>
       </a>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
       <a href="{{ url_for('clients_list') }}" class="btn btn-warning-custom w-100 h-100 d-flex flex-column justify-content-center align-items-center p-4">
        <i class="fas fa-search fa-2x mb-2"></i>
        <strong>ุงูุจุญุซ ูุงูุชุตููุฉ</strong>
        <small class="mt-1">ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุนููุงุก</small>
       </a>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
       <a href="{{ url_for('analytics_dashboard') }}" class="btn btn-info-custom w-100 h-100 d-flex flex-column justify-content-center align-items-center p-4">
        <i class="fas fa-chart-line fa-2x mb-2"></i>
        <strong>ุงูุชุญููู ุงููุชูุฏู</strong>
        <small class="mt-1">ุชุญููู ุดุงูู ูุชูุงุฑูุฑ ููุตูุฉ</small>
       </a>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
       <a href="{{ url_for('settings') }}" class="btn btn-danger-custom w-100 h-100 d-flex flex-column justify-content-center align-items-center p-4">
        <i class="fas fa-cog fa-2x mb-2"></i>
        <strong>ุงูุฅุนุฏุงุฏุงุช</strong>
        <small class="mt-1">ุฅุนุฏุงุฏุงุช ุงููุธุงู ูุงูุฅุดุนุงุฑุงุช</small>
       </a>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
</div>
{% endblock %}