{% extends "base.html" %}
{% block title %}التحليل المتقدم - {{ app_title }}{% endblock %}
{% block content %}
<div class="container-fluid">
 <!-- En-tête du tableau de bord d'analyse -->
 <div class="row mb-4">
  <div class="col-12">
   <div class="card card-modern">
    <div class="card-header-modern">
     <div class="row align-items-center">
      <div class="col">
       <h2 class="mb-0">
        <i class="fas fa-chart-line me-2"></i> التحليل المتقدم والبيانات الشاملة
       </h2>
       <p class="mb-0 mt-2 opacity-75">تحليل شامل لجميع البيانات وتقارير مفصلة</p>
      </div>
      <div class="col-auto">
       <div class="btn-group">
        <button type="button" class="btn btn-primary-custom" onclick="refreshAnalytics()">
         <i class="fas fa-sync-alt me-1"></i>تحديث
        </button>
        <button type="button" class="btn btn-success-custom" onclick="exportReport('comprehensive')">
         <i class="fas fa-download me-1"></i>تصدير تقرير
        </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>

 <!-- Statistiques en temps réel -->
 <div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card">
    <div class="stats-number" id="total-clients">{{ analysis.overview.total_clients or 0 }}</div>
    <div class="stats-label">
     <i class="fas fa-users me-1"></i> إجمالي العملاء
    </div>
   </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
    <div class="stats-number" id="success-rate">{{ analysis.overview.success_rate or 0 }}%</div>
    <div class="stats-label">
     <i class="fas fa-check-circle me-1"></i> معدل النجاح
    </div>
   </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
    <div class="stats-number" id="active-clients">{{ analysis.overview.active_clients or 0 }}</div>
    <div class="stats-label">
     <i class="fas fa-clock me-1"></i> العملاء النشطين
    </div>
   </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
   <div class="stats-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
    <div class="stats-number" id="quality-score">{{ analysis.quality_metrics.quality_score or 0 }}</div>
    <div class="stats-label">
     <i class="fas fa-star me-1"></i> جودة البيانات
    </div>
   </div>
  </div>
 </div>

 <!-- Onglets pour différents types d'analyse -->
 <div class="row mb-4">
  <div class="col-12">
   <div class="card card-modern">
    <div class="card-header-modern">
     <ul class="nav nav-tabs card-header-tabs" id="analyticsTabs" role="tablist">
      <li class="nav-item" role="presentation">
       <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
        <i class="fas fa-chart-pie me-1"></i> نظرة عامة
       </button>
      </li>
      <li class="nav-item" role="presentation">
       <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
        <i class="fas fa-tachometer-alt me-1"></i> الأداء
       </button>
      </li>
      <li class="nav-item" role="presentation">
       <button class="nav-link" id="trends-tab" data-bs-toggle="tab" data-bs-target="#trends" type="button" role="tab">
        <i class="fas fa-chart-line me-1"></i> الاتجاهات
       </button>
      </li>
      <li class="nav-item" role="presentation">
       <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
        <i class="fas fa-file-alt me-1"></i> التقارير
       </button>
      </li>
     </ul>
    </div>
    <div class="card-body">
     <div class="tab-content" id="analyticsTabContent">
      
      <!-- Onglet Vue d'ensemble -->
      <div class="tab-pane fade show active" id="overview" role="tabpanel">
       <div class="row">
        <!-- Distribution des statuts de visa -->
        <div class="col-lg-6 mb-4">
         <div class="card card-modern h-100">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-chart-pie me-2"></i> توزيع حالات التأشيرات
           </h5>
          </div>
          <div class="card-body">
           <canvas id="visaStatusChart" width="400" height="300"></canvas>
          </div>
         </div>
        </div>
        
        <!-- Distribution des nationalités -->
        <div class="col-lg-6 mb-4">
         <div class="card card-modern h-100">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-globe me-2"></i> توزيع الجنسيات
           </h5>
          </div>
          <div class="card-body">
           <canvas id="nationalityChart" width="400" height="300"></canvas>
          </div>
         </div>
        </div>
        
        <!-- Analyse par phase -->
        <div class="col-12 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-layer-group me-2"></i> تحليل المراحل
           </h5>
          </div>
          <div class="card-body">
           <div class="row">
            {% for phase, data in analysis.visa_status_analysis.phase_analysis.items() %}
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
             <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <h4 class="mb-1">{{ data.count }}</h4>
              <small>{{ phase }}</small>
              <div class="mt-2">
               <small>{{ data.percentage }}%</small>
              </div>
             </div>
            </div>
            {% endfor %}
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      
      <!-- Onglet Performance -->
      <div class="tab-pane fade" id="performance" role="tabpanel">
       <div class="row">
        <!-- Performance des employés -->
        <div class="col-lg-8 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-user-tie me-2"></i> أداء الموظفين
           </h5>
          </div>
          <div class="card-body">
           <canvas id="employeePerformanceChart" width="400" height="200"></canvas>
          </div>
         </div>
        </div>
        
        <!-- Métriques de performance -->
        <div class="col-lg-4 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i> مؤشرات الأداء
           </h5>
          </div>
          <div class="card-body">
           {% for phase, rate in analysis.performance_metrics.phase_conversion_rates.items() %}
           <div class="mb-3">
            <div class="d-flex justify-content-between">
             <span>{{ phase }}</span>
             <span class="fw-bold">{{ rate }}%</span>
            </div>
            <div class="progress" style="height: 8px;">
             <div class="progress-bar" style="width: {{ rate }}%"></div>
            </div>
           </div>
           {% endfor %}
           
           <div class="mt-4 p-3 rounded" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
            <h5 class="mb-1">نقاط الكفاءة</h5>
            <h3>{{ analysis.performance_metrics.efficiency_score }}</h3>
           </div>
          </div>
         </div>
        </div>
        
        <!-- Classement des employés -->
        <div class="col-12 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-trophy me-2"></i> ترتيب الموظفين
           </h5>
          </div>
          <div class="card-body">
           <div class="row">
            {% for employee, data in analysis.employee_analysis.employee_ranking %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
             <div class="text-center p-3 border rounded">
              <h5 class="mb-1">{{ employee }}</h5>
              <div class="mb-2">
               <span class="badge bg-primary">{{ data.total_clients }} عميل</span>
              </div>
              <div class="progress mb-2" style="height: 6px;">
               <div class="progress-bar bg-success" style="width: {{ data.success_rate }}%"></div>
              </div>
              <small class="text-muted">{{ data.success_rate }}% نجاح</small>
             </div>
            </div>
            {% endfor %}
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      
      <!-- Onglet Tendances -->
      <div class="tab-pane fade" id="trends" role="tabpanel">
       <div class="row">
        <!-- Tendances temporelles -->
        <div class="col-lg-8 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-chart-line me-2"></i> الاتجاهات الزمنية
           </h5>
          </div>
          <div class="card-body">
           <canvas id="temporalTrendChart" width="400" height="200"></canvas>
          </div>
         </div>
        </div>
        
        <!-- Analyse des tendances -->
        <div class="col-lg-4 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-analytics me-2"></i> تحليل الاتجاهات
           </h5>
          </div>
          <div class="card-body">
           <div class="mb-3">
            <h6>الاتجاه العام</h6>
            <span class="badge bg-info">{{ analysis.trends.overall_trend }}</span>
           </div>
           
           <div class="mb-3">
            <h6>الأنماط المكتشفة</h6>
            {% for pattern in analysis.trends.emerging_patterns %}
            <div class="alert alert-info alert-sm">
             <small>{{ pattern }}</small>
            </div>
            {% endfor %}
           </div>
          </div>
         </div>
        </div>
        
        <!-- Analyse géographique -->
        <div class="col-12 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-map-marked-alt me-2"></i> التحليل الجغرافي
           </h5>
          </div>
          <div class="card-body">
           <div class="row">
            {% for region, count in analysis.geographic_analysis.regional_summary.items() %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
             <div class="text-center p-3 rounded" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); color: white;">
              <h4 class="mb-1">{{ count }}</h4>
              <small>{{ region }}</small>
             </div>
            </div>
            {% endfor %}
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      
      <!-- Onglet Rapports -->
      <div class="tab-pane fade" id="reports" role="tabpanel">
       <div class="row">
        <!-- Résumé exécutif -->
        <div class="col-lg-6 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-briefcase me-2"></i> ملخص تنفيذي
           </h5>
          </div>
          <div class="card-body">
           <div class="mb-3">
            <h6>المؤشرات الرئيسية</h6>
            <div class="row">
             <div class="col-6">
              <div class="text-center p-2 border rounded">
               <h5 class="mb-0">{{ analysis.detailed_reports.executive_summary.total_clients }}</h5>
               <small>إجمالي العملاء</small>
              </div>
             </div>
             <div class="col-6">
              <div class="text-center p-2 border rounded">
               <h5 class="mb-0">{{ analysis.detailed_reports.executive_summary.success_rate }}%</h5>
               <small>معدل النجاح</small>
              </div>
             </div>
            </div>
           </div>
           
           <div class="mb-3">
            <h6>التوصيات</h6>
            {% for recommendation in analysis.detailed_reports.recommendations %}
            <div class="alert alert-warning alert-sm">
             <small>{{ recommendation }}</small>
            </div>
            {% endfor %}
           </div>
          </div>
         </div>
        </div>
        
        <!-- Métriques de qualité -->
        <div class="col-lg-6 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-check-circle me-2"></i> جودة البيانات
           </h5>
          </div>
          <div class="card-body">
           {% for field, percentage in analysis.quality_metrics.completeness_percentages.items() %}
           <div class="mb-3">
            <div class="d-flex justify-content-between">
             <span>
              {% if field == 'full_name' %}الأسماء الكاملة
              {% elif field == 'whatsapp_number' %}أرقام الواتساب
              {% elif field == 'nationality' %}الجنسيات
              {% elif field == 'visa_status' %}حالات التأشيرة
              {% elif field == 'responsible_employee' %}الموظفين المسؤولين
              {% elif field == 'passport_number' %}أرقام جوازات السفر
              {% else %}{{ field }}{% endif %}
             </span>
             <span class="fw-bold">{{ percentage }}%</span>
            </div>
            <div class="progress" style="height: 6px;">
             <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                  style="width: {{ percentage }}%"></div>
            </div>
           </div>
           {% endfor %}
           
           <div class="mt-3">
            <h6>مشاكل البيانات</h6>
            {% for issue in analysis.quality_metrics.data_issues %}
            <div class="alert alert-danger alert-sm">
             <small>{{ issue }}</small>
            </div>
            {% endfor %}
           </div>
          </div>
         </div>
        </div>
        
        <!-- Actions rapides -->
        <div class="col-12 mb-4">
         <div class="card card-modern">
          <div class="card-header-modern">
           <h5 class="mb-0">
            <i class="fas fa-download me-2"></i> تصدير التقارير
           </h5>
          </div>
          <div class="card-body">
           <div class="row">
            <div class="col-lg-3 col-md-6 mb-3">
             <button class="btn btn-primary-custom w-100" onclick="exportReport('comprehensive')">
              <i class="fas fa-file-alt me-2"></i>تقرير شامل
             </button>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
             <button class="btn btn-success-custom w-100" onclick="exportReport('executive')">
              <i class="fas fa-briefcase me-2"></i>تقرير تنفيذي
             </button>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
             <button class="btn btn-warning-custom w-100" onclick="exportReport('operational')">
              <i class="fas fa-cogs me-2"></i>تقرير تشغيلي
             </button>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
             <button class="btn btn-info-custom w-100" onclick="exportReport('real-time')">
              <i class="fas fa-clock me-2"></i>إحصائيات مباشرة
             </button>
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
      
     </div>
    </div>
   </div>
  </div>
 </div>
</div>

<!-- Scripts pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables globales pour les données
let analysisData = {{ analysis | tojson }};

// Initialiser les graphiques
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadRealTimeStats();
    
    // Actualiser les statistiques toutes les 30 secondes
    setInterval(loadRealTimeStats, 30000);
});

function initializeCharts() {
    // Graphique des statuts de visa
    const visaStatusCtx = document.getElementById('visaStatusChart').getContext('2d');
    new Chart(visaStatusCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(analysisData.visa_status_analysis.status_distribution || {}),
            datasets: [{
                data: Object.values(analysisData.visa_status_analysis.status_distribution || {}),
                backgroundColor: [
                    '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#6c757d'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Graphique des nationalités
    const nationalityCtx = document.getElementById('nationalityChart').getContext('2d');
    const nationalityData = analysisData.nationality_analysis.nationality_distribution || {};
    const sortedNationalities = Object.entries(nationalityData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
    
    new Chart(nationalityCtx, {
        type: 'bar',
        data: {
            labels: sortedNationalities.map(item => item[0]),
            datasets: [{
                label: 'عدد العملاء',
                data: sortedNationalities.map(item => item[1]),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Graphique de performance des employés
    const employeeCtx = document.getElementById('employeePerformanceChart').getContext('2d');
    const employeeData = analysisData.employee_analysis.employee_performance || {};
    const employeeLabels = Object.keys(employeeData);
    const successRates = Object.values(employeeData).map(emp => emp.success_rate);
    const totalClients = Object.values(employeeData).map(emp => emp.total_clients);
    
    new Chart(employeeCtx, {
        type: 'bar',
        data: {
            labels: employeeLabels,
            datasets: [{
                label: 'معدل النجاح (%)',
                data: successRates,
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Graphique des tendances temporelles
    const temporalCtx = document.getElementById('temporalTrendChart').getContext('2d');
    const temporalData = analysisData.temporal_analysis.monthly_distribution || {};
    const sortedTemporal = Object.entries(temporalData).sort();
    
    new Chart(temporalCtx, {
        type: 'line',
        data: {
            labels: sortedTemporal.map(item => item[0]),
            datasets: [{
                label: 'العملاء الجدد',
                data: sortedTemporal.map(item => item[1]),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function loadRealTimeStats() {
    fetch('/api/analytics/real-time-stats')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('total-clients').textContent = data.total_clients || 0;
                document.getElementById('active-clients').textContent = data.active_today || 0;
                // Mettre à jour d'autres statistiques en temps réel si nécessaire
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des statistiques:', error);
        });
}

function refreshAnalytics() {
    // Afficher un indicateur de chargement
    const refreshBtn = document.querySelector('[onclick="refreshAnalytics()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التحديث...';
    refreshBtn.disabled = true;
    
    // Recharger la page après un court délai
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function exportReport(reportType) {
    // Afficher un indicateur de chargement
    const exportBtn = event.target;
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>جاري التصدير...';
    exportBtn.disabled = true;
    
    // Créer un lien de téléchargement
    const link = document.createElement('a');
    link.href = `/api/analytics/export/${reportType}`;
    link.download = `analysis_report_${reportType}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restaurer le bouton après 2 secondes
    setTimeout(() => {
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    }, 2000);
}
</script>
{% endblock %}
