{% extends "base.html" %} {% block title %}إضافة عميل جديد - {{ app_title }}{% endblock %} {% block content %} <div class="container-fluid">  <div class="row mb-4"> <div class="col-12"> <div class="card card-modern"> <div class="card-header-modern"> <div class="row align-items-center"> <div class="col"> <h2 class="mb-0"> <i class="fas fa-user-plus me-2"></i> إضافة عميل جديد </h2> <p class="mb-0 mt-2 opacity-75">إضافة عميل جديد إلى نظام تتبع التأشيرات</p> </div> <div class="col-auto"> <a href="{{ url_for('clients_list') }}" class="btn btn-outline-light"> <i class="fas fa-arrow-right me-2"></i>العودة للقائمة </a> </div> </div> </div> </div> </div> </div>  <div class="row justify-content-center"> <div class="col-lg-10"> <div class="card card-modern"> <div class="card-body p-4"> <form method="POST" action="{{ url_for('add_client') }}" id="addClientForm"> <div class="row">  <div class="col-12 mb-4"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-info-circle me-2"></i> المعلومات الأساسية </h5> </div>  <div class="col-lg-6 mb-3"> <label for="client_id" class="form-label"> <i class="fas fa-id-card me-1"></i> معرف العميل </label> <input type="text" class="form-control" id="client_id" name="client_id" placeholder="سيتم إنشاء معرف تلقائي" readonly value=""> <div class="form-text">سيتم إنشاء معرف تلقائي: CLI0973, CLI0974, CLI0975...</div> </div>  <div class="col-lg-6 mb-3"> <label for="full_name" class="form-label required"> <i class="fas fa-user me-1"></i> الاسم الكامل </label> <input type="text" class="form-control" id="full_name" name="full_name" required placeholder="أدخل الاسم الكامل للعميل"> <div class="form-text">الاسم الكامل للعميل (مطلوب)</div> </div>  <div class="col-lg-6 mb-3"> <label for="whatsapp_number" class="form-label"> <i class="fab fa-whatsapp me-1"></i> رقم الواتساب </label> <input type="tel" class="form-control" id="whatsapp_number" name="whatsapp_number" placeholder="مثال: +216XXXXXXXX"> <div class="form-text">رقم الواتساب لإرسال الإشعارات</div> </div>  <div class="col-lg-6 mb-3"> <label for="nationality" class="form-label"> <i class="fas fa-globe me-1"></i> الجنسية </label> <select class="form-select" id="nationality" name="nationality"> <option value="">اختر الجنسية</option> {% for nationality in nationalities %} <option value="{{ nationality }}">{{ nationality }}</option> {% endfor %} </select> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-passport me-2"></i> معلومات جواز السفر </h5> </div>  <div class="col-lg-6 mb-3"> <label for="passport_number" class="form-label required"> <i class="fas fa-passport me-1"></i> رقم جواز السفر </label> <input type="text" class="form-control" id="passport_number" name="passport_number" required placeholder="أدخل رقم جواز السفر"> <div class="form-text">رقم جواز السفر (مطلوب - يجب أن يكون فريد)</div> </div>  <div class="col-lg-6 mb-3"> <label for="passport_status" class="form-label"> <i class="fas fa-check-circle me-1"></i> حالة جواز السفر </label> <select class="form-select" id="passport_status" name="passport_status"> <option value="">اختر حالة الجواز</option> {% for status in passport_statuses %} <option value="{{ status }}">{{ status }}</option> {% endfor %} </select> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-calendar me-2"></i> التواريخ المهمة </h5> </div>  <div class="col-lg-6 mb-3"> <label for="application_date" class="form-label"> <i class="fas fa-calendar-plus me-1"></i> تاريخ التقديم </label> <input type="date" class="form-control" id="application_date" name="application_date"> <div class="form-text">تاريخ تقديم طلب التأشيرة</div> </div>  <div class="col-lg-6 mb-3"> <label for="receipt_date" class="form-label"> <i class="fas fa-calendar-check me-1"></i> تاريخ استلام للسفارة </label> <input type="date" class="form-control" id="receipt_date" name="receipt_date"> <div class="form-text">تاريخ استلام للسفارة من العميل</div> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-cogs me-2"></i> معلومات المعالجة </h5> </div>  <div class="col-lg-6 mb-3"> <label for="visa_status" class="form-label"> <i class="fas fa-tasks me-1"></i> حالة تتبع التأشيرة </label> <select class="form-select" id="visa_status" name="visa_status"> {% for status in visa_statuses %} <option value="{{ status }}" {% if status == 'التقديم' %}selected{% endif %}> {{ status }} </option> {% endfor %} </select> <div class="form-text">الحالة الحالية لطلب التأشيرة</div> </div>  <div class="col-lg-6 mb-3"> <label for="responsible_employee" class="form-label"> <i class="fas fa-user-tie me-1"></i> الموظف المسؤول </label> <select class="form-select" id="responsible_employee" name="responsible_employee"> <option value="">اختر الموظف المسؤول</option> {% for employee in employees %} <option value="{{ employee }}">{{ employee }}</option> {% endfor %} </select> </div>  <div class="col-lg-12 mb-3"> <label for="processed_by" class="form-label"> <i class="fas fa-user-check me-1"></i> من طرف </label> <input type="text" class="form-control" id="processed_by" name="processed_by" placeholder="اسم الشخص الذي عالج الطلب"> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-sticky-note me-2"></i> معلومات إضافية </h5> </div>  <div class="col-lg-12 mb-3"> <label for="summary" class="form-label"> <i class="fas fa-file-alt me-1"></i> الخلاصة </label> <textarea class="form-control" id="summary" name="summary" rows="3" placeholder="ملخص موجز عن حالة العميل والطلب"></textarea> </div>  <div class="col-lg-12 mb-3"> <label for="notes" class="form-label"> <i class="fas fa-comment me-1"></i> ملاحظات </label> <textarea class="form-control" id="notes" name="notes" rows="4" placeholder="أي ملاحظات إضافية أو تفاصيل مهمة"></textarea> </div> </div>  <div class="row mt-4"> <div class="col-12"> <div class="d-flex justify-content-end gap-3"> <a href="{{ url_for('clients_list') }}" class="btn btn-outline-secondary btn-lg"> <i class="fas fa-times me-2"></i>إلغاء </a> <button type="reset" class="btn btn-outline-warning btn-lg"> <i class="fas fa-undo me-2"></i>إعادة تعيين </button> <button type="submit" class="btn btn-success-custom btn-lg"> <i class="fas fa-save me-2"></i>حفظ العميل </button> </div> </div> </div> </form> </div> </div> </div> </div> </div> {% endblock %} {% block extra_css %} <style> .required::after { content: " *"; color: #dc3545; font-weight: bold; } .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(31, 83, 141, 0.25); } .form-text { font-size: 0.875rem; color: #6c757d; } .border-bottom { border-bottom: 2px solid #e9ecef !important; } .section-header { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; } </style> {% endblock %} {% block extra_js %} <script> // Form validation document.getElementById('addClientForm').addEventListener('submit', function(e) { const fullName = document.getElementById('full_name').value.trim(); const passportNumber = document.getElementById('passport_number').value.trim(); // Note: client_id sera généré automatiquement côté serveur, pas besoin de vérifier if (!fullName) { e.preventDefault(); alert('يرجى إدخال الاسم الكامل'); document.getElementById('full_name').focus(); return; } if (!passportNumber) { e.preventDefault(); alert('يرجى إدخال رقم جواز السفر'); document.getElementById('passport_number').focus(); return; } // Show loading showLoading(); }); // Auto-generate client ID based on name document.getElementById('full_name').addEventListener('blur', function() { const clientIdField = document.getElementById('client_id'); // Always clear the client_id field to let server generate CLI format ID clientIdField.value = ''; }); // Ensure client_id field is always empty on form load document.addEventListener('DOMContentLoaded', function() { const clientIdField = document.getElementById('client_id'); if (clientIdField) { clientIdField.value = ''; } }); // Phone number formatting document.getElementById('whatsapp_number').addEventListener('input', function() { let value = this.value.replace(/\D/g, ''); // Remove non-digits // Add country code if not present if (value.length > 0 && !value.startsWith('216') && !value.startsWith('218')) { if (value.startsWith('0')) { value = '216' + value.substring(1); } else if (value.length === 8) { value = '216' + value; } } this.value = value; }); // Set default dates document.addEventListener('DOMContentLoaded', function() { const today = new Date().toISOString().split('T')[0]; // Set application date to today if empty const appDateField = document.getElementById('application_date'); if (!appDateField.value) { appDateField.value = today; } }); // Form auto-save to localStorage function autoSave() { const formData = new FormData(document.getElementById('addClientForm')); const data = {}; for (let [key, value] of formData.entries()) { data[key] = value; } localStorage.setItem('addClientFormData', JSON.stringify(data)); } // Load saved form data function loadSavedData() { const savedData = localStorage.getItem('addClientFormData'); if (savedData) { const data = JSON.parse(savedData); for (let [key, value] of Object.entries(data)) { const field = document.getElementById(key); if (field) { field.value = value; } } } } // Clear saved data on successful submit document.getElementById('addClientForm').addEventListener('submit', function() { localStorage.removeItem('addClientFormData'); }); // Auto-save every 30 seconds setInterval(autoSave, 30000); // Load saved data on page load document.addEventListener('DOMContentLoaded', loadSavedData); // Passport number validation with real-time check document.getElementById('passport_number').addEventListener('blur', function() { const passportNumber = this.value.trim(); if (passportNumber) { // Check if passport number is unique fetch('/api/check-passport-unique', { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ passport_number: passportNumber }) }) .then(response => response.json()) .then(data => { if (!data.unique) { this.style.borderColor = '#dc3545'; this.style.backgroundColor = '#f8d7da'; // Show error message let errorDiv = document.getElementById('passport-error'); if (!errorDiv) { errorDiv = document.createElement('div'); errorDiv.id = 'passport-error'; errorDiv.className = 'text-danger mt-1'; errorDiv.style.fontSize = '0.875rem'; this.parentNode.appendChild(errorDiv); } errorDiv.textContent = 'رقم جواز السفر موجود مسبقاً. يرجى إدخال رقم آخر.'; } else { this.style.borderColor = '#28a745'; this.style.backgroundColor = '#d4edda'; // Remove error message const errorDiv = document.getElementById('passport-error'); if (errorDiv) { errorDiv.remove(); } } }) .catch(error => { console.error('Error checking passport uniqueness:', error); }); } else { // Reset styling if empty this.style.borderColor = ''; this.style.backgroundColor = ''; const errorDiv = document.getElementById('passport-error'); if (errorDiv) { errorDiv.remove(); } } }); </script> {% endblock %}