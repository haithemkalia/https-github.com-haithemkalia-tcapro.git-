{% extends "base.html" %} {% block title %}إدارة العملاء - {{ app_title }}{% endblock %} {% block content %} <div class="container-fluid">  <div class="row mb-4"> <div class="col-12"> <div class="card card-modern"> <div class="card-header-modern"> <div class="row align-items-center"> <div class="col"> <h2 class="mb-0"> <i class="fas fa-users me-2"></i> إدارة العملاء </h2> <p class="mb-0 mt-2 opacity-75">عرض وإدارة جميع عملاء النظام</p> </div> <div class="col-auto"> <a href="{{ url_for('add_client') }}" class="btn btn-success-custom"> <i class="fas fa-plus me-2"></i>إضافة عميل جديد </a> </div> </div> </div> </div> </div> </div>  <div class="row mb-4"> <div class="col-12"> <div class="card card-modern"> <div class="card-body"> <form method="GET" action="{{ url_for('clients_list') }}" class="row g-3">  <div class="col-lg-4 col-md-6"> <label for="search" class="form-label"> <i class="fas fa-search me-1"></i>البحث الفوري </label> <input type="text" class="form-control" id="search" name="search" value="{{ search_term }}" placeholder="اكتب للبحث الفوري..."> <div id="searchResults" class="search-results-dropdown" style="display: none;"></div> </div>  <div class="col-lg-2 col-md-6"> <label for="status" class="form-label"> <i class="fas fa-filter me-1"></i>حالة التأشيرة </label> <select class="form-select" id="status" name="status"> <option value="">جميع الحالات</option> {% for status in visa_statuses %} <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}> {{ status }} </option> {% endfor %} </select> </div>  <div class="col-lg-2 col-md-6"> <label for="nationality" class="form-label"> <i class="fas fa-globe me-1"></i>الجنسية </label> <select class="form-select" id="nationality" name="nationality"> <option value="">جميع الجنسيات</option> {% for nationality in nationalities %} <option value="{{ nationality }}" {% if nationality_filter == nationality %}selected{% endif %}> {{ nationality }} </option> {% endfor %} </select> </div>  <div class="col-lg-2 col-md-6"> <label for="employee" class="form-label"> <i class="fas fa-user-tie me-1"></i>الموظف المسؤول </label> <select class="form-select" id="employee" name="employee"> <option value="">جميع الموظفين</option> {% for employee in employees %} <option value="{{ employee }}" {% if employee_filter == employee %}selected{% endif %}> {{ employee }} </option> {% endfor %} </select> </div>  <div class="col-lg-2 col-md-12"> <label class="form-label">&nbsp;</label> <div class="d-flex gap-2"> <button type="submit" class="btn btn-primary-custom flex-fill"> <i class="fas fa-search"></i> </button> <a href="{{ url_for('clients_list') }}" class="btn btn-outline-secondary flex-fill"> <i class="fas fa-times"></i> </a> </div> </div> </form> </div> </div> </div> </div>  <div class="row mb-3"> <div class="col-12"> <div class="d-flex justify-content-between align-items-center"> <h5 class="mb-0"> <i class="fas fa-list me-2"></i> النتائج: {{ clients|length }} عميل {% if search_term or status_filter or nationality_filter or employee_filter %} <small class="text-muted">(مفلترة)</small> {% endif %} </h5> <div> <button class="btn btn-outline-primary btn-sm" onclick="exportToExcel()"> <i class="fas fa-download me-1"></i>تصدير Excel </button> <button class="btn btn-outline-danger btn-sm ms-2" onclick="deleteAllClients()"> <i class="fas fa-trash me-1"></i>حذف جميع العملاء </button> <button class="btn btn-outline-warning btn-sm ms-2" onclick="deleteAllClientsDirect()" title="حذف مباشر - بدون تأكيد"> <i class="fas fa-bolt me-1"></i>حذف مباشر </button> </div> </div> </div> </div>  <div class="row"> <div class="col-12"> <div class="card card-modern"> <div class="card-body p-0"> {% if clients and clients|length > 0 %} <div class="table-responsive"> <table class="table table-modern table-hover mb-0" id="clientsTable"> <thead> <tr> <th>ملاحظة</th> <th>اختيار الموظف مسؤول</th> <th>الخلاصة</th> <th>من طرف</th> <th>حالة تتبع التأشيرة</th> <th>الجنسية</th> <th>حالة جواز السفر</th> <th>رقم جواز السفر</th> <th>تاريخ استلام للسفارة</th> <th>تاريخ التقديم</th> <th>رقم الواتساب</th> <th>الاسم الكامل</th> <th>معرف العميل</th> <th>الإجراءات</th> </tr> </thead> <tbody> {% for client in clients %} <tr> <td>{{ client.get('notes', '') or 'غير محدد' }}</td> <td> <div class="inline-edit-container" data-field="responsible_employee" data-client-id="{{ client.get('client_id', '') }}"> <div class="inline-edit-display"> {% if client.get('responsible_employee') %} <span class="badge bg-info">{{ client.get('responsible_employee', '') }}</span> {% else %} <span class="text-muted">غير محدد</span> {% endif %} <i class="fas fa-edit edit-icon"></i> </div> <select class="inline-edit-input form-select" style="display: none;"> <option value="">اختر الموظف</option> {% for employee in employees %} <option value="{{ employee }}" {% if client.get('responsible_employee') == employee %}selected{% endif %}>{{ employee }}</option> {% endfor %} </select> </div> </td> <td>{{ client.get('summary', '') or 'غير محدد' }}</td> <td> {% if client.get('processed_by') %} <span class="badge bg-info">{{ client.get('processed_by', '') }}</span> {% else %} <span class="text-muted">غير محدد</span> {% endif %} </td> <td> <div class="inline-edit-container" data-field="visa_status" data-client-id="{{ client.get('client_id', '') }}"> <div class="inline-edit-display"> <span class="status-badge status-{{ client.get('visa_status', '').replace(' ', '-') }}">{{ client.get('visa_status', '') }}</span> <i class="fas fa-edit edit-icon"></i> </div> <select class="inline-edit-input form-select" style="display: none;"> <option value="">اختر الحالة</option> {% for status in visa_statuses %} <option value="{{ status }}" {% if client.get('visa_status') == status %}selected{% endif %}>{{ status }}</option> {% endfor %} </select> </div> </td> <td> {% if client.get('nationality') %} <span class="badge bg-secondary">{{ client.get('nationality', '') }}</span> {% else %} <span class="text-muted">غير محدد</span> {% endif %} </td> <td> {% if client.get('passport_status') %} <span class="badge bg-secondary">{{ client.get('passport_status', '') }}</span> {% else %} <span class="text-muted">غير محدد</span> {% endif %} </td> <td> {% if client.get('passport_number') %} <small>{{ client.get('passport_number', '') }}</small> {% else %} <span class="text-muted">غير محدد</span> {% endif %} </td> <td> <div class="inline-edit-container" data-field="transaction_date" data-client-id="{{ client.get('client_id', '') }}"> <div class="inline-edit-display"> {% if client.get('transaction_date') %} <small>{{ client.get('transaction_date', '') }}</small> {% else %} <span class="text-muted">غير محدد</span> {% endif %} <i class="fas fa-edit edit-icon"></i> </div> <input type="date" class="inline-edit-input form-control" style="display: none;" value="{{ client.get('transaction_date', '') or '' }}"> </div> </td> <td> <div class="inline-edit-container" data-field="application_date" data-client-id="{{ client.get('client_id', '') }}"> <div class="inline-edit-display"> {% if client.get('application_date') %} <small>{{ client.get('application_date', '') }}</small> {% else %} <span class="text-muted">غير محدد</span> {% endif %} <i class="fas fa-edit edit-icon"></i> </div> <input type="date" class="inline-edit-input form-control" style="display: none;" value="{{ client.get('application_date', '') or '' }}"> </div> </td> <td> {% if client.get('whatsapp_number') %} <a href="https://wa.me/{{ client.get('whatsapp_number', '') }}" target="_blank" class="text-success text-decoration-none"> <i class="fab fa-whatsapp me-1"></i>{{ client.get('whatsapp_number', '') }} </a> {% else %} <span class="text-muted">غير محدد</span> {% endif %} </td> <td><strong>{{ client.get('full_name', '') }}</strong></td> <td><strong class="text-primary">{{ client.get('client_id', '') }}</strong></td> <td> <div class="btn-group" role="group"> <a href="{{ url_for('edit_client', client_id=client.get('client_id', '')) }}" class="btn btn-outline-primary btn-sm" title="تعديل"> <i class="fas fa-edit"></i> </a> <a href="{{ url_for('send_whatsapp', client_id=client.get('client_id', '')) }}" class="btn btn-outline-success btn-sm" title="إرسال رسالة واتساب مخصصة"> <i class="fab fa-whatsapp"></i> </a> <button class="btn btn-outline-danger btn-sm" onclick="deleteClient('{{ client.get('client_id', '')|escape }}')" title="حذف"> <i class="fas fa-trash"></i> </button> </div> </td> </tr> {% endfor %} </tbody> </table> </div> {% else %} {% if pagination and pagination.total > 0 %} <div class="alert alert-warning m-3" role="alert"> <i class="fas fa-exclamation-triangle me-2"></i> يوجد سجلات في قاعدة البيانات ({{ pagination.total }}) لكن لا يظهر أي صف هنا. قد يكون السبب عدم توافق أسماء الأعمدة مع العرض. جرب تحديث الصفحة أو إزالة الفلاتر. إذا استمر المشكلة، سنقوم بمواءمة الحقول فورًا. </div> {% endif %} <div class="text-center py-5"> <i class="fas fa-search fa-3x text-muted mb-3"></i> <h5 class="text-muted">لا توجد نتائج</h5> {% if search_term or status_filter or nationality_filter or employee_filter %} <p class="text-muted">لم يتم العثور على عملاء يطابقون معايير البحث</p> <a href="{{ url_for('clients_list') }}" class="btn btn-outline-primary"> <i class="fas fa-times me-2"></i>إزالة الفلاتر </a> {% else %} <p class="text-muted">لا توجد عملاء في النظام حتى الآن</p> <a href="{{ url_for('add_client') }}" class="btn btn-primary-custom"> <i class="fas fa-plus me-2"></i>إضافة عميل جديد </a> {% endif %} </div> {% endif %}  {% if pagination and pagination.total > 0 %} <div class="row mt-4"> <div class="col-md-6"> <p class="text-muted"> عرض {{ ((pagination.page - 1) * pagination.per_page) + 1 }} إلى {{ min(pagination.page * pagination.per_page, pagination.total) }} من {{ pagination.total }} عميل </p> </div> <div class="col-md-6"> <nav aria-label="تنقل الصفحات"> <ul class="pagination justify-content-end">  {% if pagination.has_prev %} <li class="page-item"> <a class="page-link" href="{{ url_for('clients_list', page=pagination.prev_num, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter, per_page=pagination.per_page) }}"> <i class="fas fa-chevron-right"></i> السابق </a> </li> {% else %} <li class="page-item disabled"> <span class="page-link"><i class="fas fa-chevron-right"></i> السابق</span> </li> {% endif %}  {% set start_page = max(1, pagination.page - 2) %} {% set end_page = min(pagination.total_pages, pagination.page + 2) %} {% if start_page > 1 %} <li class="page-item"> <a class="page-link" href="{{ url_for('clients_list', page=1, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter, per_page=pagination.per_page) }}">1</a> </li> {% if start_page > 2 %} <li class="page-item disabled"> <span class="page-link">...</span> </li> {% endif %} {% endif %} {% for page_num in range(start_page, end_page + 1) %} {% if page_num == pagination.page %} <li class="page-item active"> <span class="page-link">{{ page_num }}</span> </li> {% else %} <li class="page-item"> <a class="page-link" href="{{ url_for('clients_list', page=page_num, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter, per_page=pagination.per_page) }}">{{ page_num }}</a> </li> {% endif %} {% endfor %} {% if end_page < pagination.total_pages %} {% if end_page < pagination.total_pages - 1 %} <li class="page-item disabled"> <span class="page-link">...</span> </li> {% endif %} <li class="page-item"> <a class="page-link" href="{{ url_for('clients_list', page=pagination.total_pages, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter, per_page=pagination.per_page) }}">{{ pagination.total_pages }}</a> </li> {% endif %}  {% if pagination.has_next %} <li class="page-item"> <a class="page-link" href="{{ url_for('clients_list', page=pagination.next_num, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter, per_page=pagination.per_page) }}"> التالي <i class="fas fa-chevron-left"></i> </a> </li> {% else %} <li class="page-item disabled"> <span class="page-link">التالي <i class="fas fa-chevron-left"></i></span> </li> {% endif %} </ul> </nav> </div> </div>  <div class="row mt-3"> <div class="col-md-12 text-center"> <div class="btn-group" role="group" aria-label="عدد العناصر في الصفحة"> <span class="btn btn-outline-secondary disabled">عدد العناصر:</span> {% for per_page_option in [25, 50, 100, 200] %} {% if per_page_option == pagination.per_page %} <button class="btn btn-primary" disabled>{{ per_page_option }}</button> {% else %} <a href="{{ url_for('clients_list', page=1, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter, per_page=per_page_option) }}" class="btn btn-outline-primary">{{ per_page_option }}</a> {% endif %} {% endfor %} </div> </div> </div> {% endif %} </div> </div> </div> </div> </div>  <div class="modal fade" id="deleteModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title"> <i class="fas fa-exclamation-triangle text-danger me-2"></i> تأكيد الحذف </h5> <button type="button" class="btn-close" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p>هل أنت متأكد من حذف هذا العميل؟</p> <p class="text-danger"><strong>تحذير:</strong> هذا الإجراء لا يمكن التراجع عنه!</p> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button> <form id="deleteForm" method="POST" style="display: inline;"> <button type="submit" class="btn btn-danger">حذف</button> </form> </div> </div> </div> </div>  <div class="modal fade" id="deleteAllModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header bg-danger text-white"> <h5 class="modal-title"> <i class="fas fa-exclamation-triangle me-2"></i> تأكيد حذف جميع العملاء </h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="alert alert-danger"> <h6><i class="fas fa-warning me-2"></i>تحذير هام!</h6> <p>أنت على وشك حذف <strong>جميع العملاء</strong> من النظام.</p> <p>سيتم حذف <strong>{{ pagination.total }}</strong> عميل نهائياً.</p> <p class="mb-0"><strong>هذا الإجراء لا يمكن التراجع عنه!</strong></p> </div> <div class="form-group"> <label for="deleteAllConfirmation" class="form-label"> <strong>للتأكيد، اكتب "DELETE_ALL_CLIENTS" في الحقل أدناه:</strong> </label> <input type="text" class="form-control" id="deleteAllConfirmation" placeholder="اكتب DELETE_ALL_CLIENTS هنا" autocomplete="off" name="confirmation"> <small class="form-text text-muted"> <i class="fas fa-info-circle"></i> يجب كتابة النص بالأحرف الإنجليزية الكبيرة والشرطات السفلية </small> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> <i class="fas fa-times me-2"></i>إلغاء </button> <button type="button" class="btn btn-danger" id="confirmDeleteAllBtn" disabled> <i class="fas fa-trash me-2"></i>حذف جميع العملاء </button> </div> </div> </div> </div> {% endblock %} {% block extra_js %} <script> // Loading functions function showLoading() { // Create loading overlay if it doesn't exist let loadingOverlay = document.getElementById('loadingOverlay'); if (!loadingOverlay) { loadingOverlay = document.createElement('div'); loadingOverlay.id = 'loadingOverlay'; loadingOverlay.innerHTML = ` <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;"> <div style="background: white; padding: 20px; border-radius: 5px; text-align: center;"> <i class="fas fa-spinner fa-spin fa-2x"></i> <p style="margin-top: 10px;">جاري المعالجة...</p> </div> </div> `; document.body.appendChild(loadingOverlay); } loadingOverlay.style.display = 'block'; } function hideLoading() { const loadingOverlay = document.getElementById('loadingOverlay'); if (loadingOverlay) { loadingOverlay.style.display = 'none'; } } // Update client status function function updateStatus(clientId, status) { showLoading(); fetch(`/api/client/${clientId}/status`, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ status: status }) }) .then(response => response.json()) .then(data => { hideLoading(); if (data.success) { // Reload the page to show the updated status location.reload(); } else { alert('خطأ في تحديث الحالة: ' + data.message); } }) .catch(error => { hideLoading(); alert('خطأ في الاتصال: ' + error.message); }); } // Delete client function function deleteClient(clientId) { const deleteForm = document.getElementById('deleteForm'); deleteForm.action = `/client/delete/${clientId}`; const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal')); deleteModal.show(); } // Delete all clients function function deleteAllClients() { const deleteAllModal = new bootstrap.Modal(document.getElementById('deleteAllModal')); deleteAllModal.show(); // Réinitialiser le champ de confirmation document.getElementById('deleteAllConfirmation').value = ''; document.getElementById('confirmDeleteAllBtn').disabled = true; } function deleteAllClientsDirect() { // Suppression directe sans confirmation if (confirm('⚠️ تحذير: سيتم حذف جميع العملاء فوراً! هل أنت متأكد؟')) { // Créer et soumettre le formulaire directement const form = document.createElement('form'); form.method = 'POST'; form.action = '/delete-all-clients-direct'; document.body.appendChild(form); form.submit(); } } // Handle delete all confirmation input document.addEventListener('DOMContentLoaded', function() { const deleteAllConfirmation = document.getElementById('deleteAllConfirmation'); const confirmDeleteAllBtn = document.getElementById('confirmDeleteAllBtn'); if (deleteAllConfirmation && confirmDeleteAllBtn) { deleteAllConfirmation.addEventListener('input', function() { confirmDeleteAllBtn.disabled = this.value.trim() !== 'DELETE_ALL_CLIENTS'; }); // Handle confirm delete all button click confirmDeleteAllBtn.addEventListener('click', function() { if (deleteAllConfirmation.value.trim() === 'DELETE_ALL_CLIENTS') { // Create a form and submit it const form = document.createElement('form'); form.method = 'POST'; form.action = '/delete-all-clients'; // Add confirmation input const input = document.createElement('input'); input.type = 'hidden'; input.name = 'confirmation'; input.value = 'DELETE_ALL_CLIENTS'; form.appendChild(input); // Add CSRF token if available (for security) const csrfToken = document.querySelector('meta[name="csrf-token"]'); if (csrfToken) { const csrfInput = document.createElement('input'); csrfInput.type = 'hidden'; csrfInput.name = 'csrf_token'; csrfInput.value = csrfToken.content; form.appendChild(csrfInput); } document.body.appendChild(form); form.submit(); } }); } // Auto-submit form on filter change const filters = ['status', 'nationality', 'employee']; filters.forEach(filterId => { const element = document.getElementById(filterId); if (element) { element.addEventListener('change', function() { this.form.submit(); }); } }); // Recherche instantanée - Initialisation let searchTimeout; const searchInput = document.getElementById('search'); const searchResults = document.getElementById('searchResults'); let currentSearchTerm = ''; // Fonction de recherche instantanée function performInstantSearch(searchTerm) { if (searchTerm.length < 2) { searchResults.style.display = 'none'; return; } fetch(`/api/search-instant?q=${encodeURIComponent(searchTerm)}`) .then(response => response.json()) .then(data => { if (data.results && data.results.length > 0) { displaySearchResults(data.results, data.total, searchTerm); } else { displayNoResults(searchTerm); } }) .catch(error => { console.error('Erreur de recherche:', error); searchResults.style.display = 'none'; }); } // Afficher les résultats de recherche function displaySearchResults(results, total, searchTerm) { let html = '<div class="search-results-header">'; html += `<strong>نتائج البحث: ${results.length} من ${total}</strong>`; html += '</div>'; results.forEach(client => { html += `<div class="search-result-item" onclick="selectClient('${client.client_id}')">`; html += `<div class="client-id">${client.client_id}</div>`; html += `<div class="client-name">${client.full_name}</div>`; html += `<div class="client-details">`; if (client.whatsapp_number) { html += `<small class="text-muted"><i class="fab fa-whatsapp"></i> ${client.whatsapp_number}</small>`; } if (client.passport_number) { html += `<small class="text-muted ms-2"><i class="fas fa-passport"></i> ${client.passport_number}</small>`; } html += `</div>`; html += `<div class="client-status">`; html += `<span class="badge bg-info">${client.visa_status}</span>`; html += `<span class="badge bg-secondary ms-1">${client.nationality}</span>`; html += `</div>`; html += '</div>'; }); searchResults.innerHTML = html; searchResults.style.display = 'block'; } // Afficher aucun résultat function displayNoResults(searchTerm) { searchResults.innerHTML = `<div class="no-results">لا توجد نتائج لـ "${searchTerm}"</div>`; searchResults.style.display = 'block'; } // Sélectionner un client function selectClient(clientId) { window.location.href = `/client/edit/${clientId}`; } // Recherche instantanée avec délai if (searchInput) { searchInput.addEventListener('input', function() { const searchTerm = this.value.trim(); currentSearchTerm = searchTerm; clearTimeout(searchTimeout); if (searchTerm.length >= 2) { searchTimeout = setTimeout(() => { performInstantSearch(searchTerm); }, 300); } else { searchResults.style.display = 'none'; } }); } // Masquer les résultats en cliquant ailleurs document.addEventListener('click', function(e) { if (searchInput && searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target)) { searchResults.style.display = 'none'; } }); // Masquer les résultats en appuyant sur Escape document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && searchResults) { searchResults.style.display = 'none'; if (searchInput) searchInput.blur(); } }); }); // Send WhatsApp notification function sendWhatsApp(clientId, status) { showLoading(); // This would trigger the WhatsApp notification fetch(`/api/client/${clientId}/status`, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ status: status }) }) .then(response => response.json()) .then(data => { hideLoading(); if (data.success) { alert('تم إرسال إشعار الواتساب بنجاح! ✅'); } else { alert('خطأ في إرسال الإشعار: ' + data.message); } }) .catch(error => { hideLoading(); alert('خطأ في الاتصال: ' + error.message); }); } // Export to Excel function function exportToExcel() { const table = document.getElementById('clientsTable'); const wb = XLSX.utils.table_to_book(table, {sheet: 'العملاء'}); XLSX.writeFile(wb, 'clients_export.xlsx'); } // Auto-submit form on filter change document.addEventListener('DOMContentLoaded', function() { const filters = ['status', 'nationality', 'employee']; filters.forEach(filterId => { const element = document.getElementById(filterId); if (element) { element.addEventListener('change', function() { this.form.submit(); }); } }); // Édition en ligne - Initialisation multiple pour s'assurer que ça fonctionne setTimeout(function() { initializeInlineEditing(); }, 100); setTimeout(function() { initializeInlineEditing(); }, 500); setTimeout(function() { initializeInlineEditing(); }, 1000); // Initialisation immédiate si le DOM est déjà prêt if (document.readyState === 'complete') { initializeInlineEditing(); } }); // Fonction pour initialiser l'édition en ligne function initializeInlineEditing() { console.log('Initialisation de l\'édition en ligne...'); try { // Ajouter les événements de clic sur les conteneurs d'édition en ligne const containers = document.querySelectorAll('.inline-edit-container'); console.log('Conteneurs trouvés:', containers.length); containers.forEach((container, index) => { const display = container.querySelector('.inline-edit-display'); const input = container.querySelector('.inline-edit-input'); const editIcon = container.querySelector('.edit-icon'); console.log(`Conteneur ${index}:`, { display: !!display, input: !!input, editIcon: !!editIcon }); if (display && input && editIcon) { // Supprimer les anciens événements pour éviter les doublons display.removeEventListener('click', handleDisplayClick); editIcon.removeEventListener('click', handleIconClick); // Clic sur l'affichage pour activer l'édition display.addEventListener('click', handleDisplayClick); // Clic sur l'icône d'édition editIcon.addEventListener('click', handleIconClick); // Gestion des événements de l'input if (input.tagName === 'SELECT') { input.removeEventListener('change', handleSelectChange); input.removeEventListener('blur', handleInputBlur); input.addEventListener('change', handleSelectChange); input.addEventListener('blur', handleInputBlur); } else if (input.tagName === 'INPUT') { input.removeEventListener('blur', handleInputBlur); input.removeEventListener('keydown', handleInputKeydown); input.addEventListener('blur', handleInputBlur); input.addEventListener('keydown', handleInputKeydown); } } }); // Fonctions de gestion des événements function handleDisplayClick(e) { e.stopPropagation(); const container = e.target.closest('.inline-edit-container'); if (container) activateInlineEdit(container); } function handleIconClick(e) { e.stopPropagation(); const container = e.target.closest('.inline-edit-container'); if (container) activateInlineEdit(container); } function handleSelectChange(e) { const container = e.target.closest('.inline-edit-container'); if (container) saveInlineEdit(container); } function handleInputBlur(e) { const container = e.target.closest('.inline-edit-container'); if (container) saveInlineEdit(container); } function handleInputKeydown(e) { const container = e.target.closest('.inline-edit-container'); if (container) { if (e.key === 'Enter') { saveInlineEdit(container); } else if (e.key === 'Escape') { cancelInlineEdit(container); } } } } catch (error) { console.error('Erreur lors de l\'initialisation de l\'édition en ligne:', error); } // Activer l'édition en ligne function activateInlineEdit(container) { const display = container.querySelector('.inline-edit-display'); const input = container.querySelector('.inline-edit-input'); if (display && input) { display.style.display = 'none'; input.style.display = 'block'; input.focus(); // Sélectionner le texte pour les inputs if (input.tagName === 'INPUT' && input.type !== 'date') { input.select(); } } } // Sauvegarder l'édition en ligne function saveInlineEdit(container) { const display = container.querySelector('.inline-edit-display'); const input = container.querySelector('.inline-edit-input'); const field = container.dataset.field; const clientId = container.dataset.clientId; const newValue = input.value.trim(); if (display && input && field && clientId) { // Afficher un indicateur de chargement showInlineEditLoading(container, true); // Envoyer la requête de mise à jour fetch(`/api/client/${clientId}/update-field`, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ field: field, value: newValue }) }) .then(response => response.json()) .then(data => { showInlineEditLoading(container, false); if (data.success) { // Mettre à jour l'affichage updateInlineEditDisplay(container, newValue, field); // Afficher un message de succès showInlineEditMessage(container, 'تم التحديث بنجاح!', 'success'); } else { // Afficher un message d'erreur showInlineEditMessage(container, data.message || 'خطأ في التحديث', 'error'); // Annuler l'édition cancelInlineEdit(container); } }) .catch(error => { showInlineEditLoading(container, false); showInlineEditMessage(container, 'خطأ في الاتصال', 'error'); cancelInlineEdit(container); }); } } // Annuler l'édition en ligne function cancelInlineEdit(container) { const display = container.querySelector('.inline-edit-display'); const input = container.querySelector('.inline-edit-input'); if (display && input) { display.style.display = 'block'; input.style.display = 'none'; } } // Mettre à jour l'affichage après sauvegarde function updateInlineEditDisplay(container, newValue, field) { const display = container.querySelector('.inline-edit-display'); if (display) { if (field === 'visa_status') { const badge = display.querySelector('.status-badge'); if (badge) { badge.textContent = newValue; badge.className = `status-badge status-${newValue.replace(' ', '-')}`; } } else if (field === 'responsible_employee') { const badge = display.querySelector('.badge'); if (badge) { badge.textContent = newValue; } else { display.innerHTML = `<span class="badge bg-info">${newValue}</span><i class="fas fa-edit edit-icon"></i>`; } } else if (field === 'application_date' || field === 'transaction_date') { const small = display.querySelector('small'); if (small) { small.textContent = newValue; } else { display.innerHTML = `<small>${newValue}</small><i class="fas fa-edit edit-icon"></i>`; } } } } // Afficher l'indicateur de chargement function showInlineEditLoading(container, show) { const loadingIndicator = container.querySelector('.inline-edit-loading'); if (show) { if (!loadingIndicator) { const loading = document.createElement('div'); loading.className = 'inline-edit-loading'; loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; container.appendChild(loading); } } else { if (loadingIndicator) { loadingIndicator.remove(); } } } // Afficher un message function showInlineEditMessage(container, message, type) { const messageDiv = document.createElement('div'); messageDiv.className = `inline-edit-message ${type}`; messageDiv.textContent = message; container.appendChild(messageDiv); // Supprimer le message après 3 secondes setTimeout(() => { if (messageDiv.parentNode) { messageDiv.remove(); } }, 3000); } </script>  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> {% endblock %}