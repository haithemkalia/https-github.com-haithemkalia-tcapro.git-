{% extends "base.html" %} {% block title %}تعديل العميل - {{ client.full_name }} - {{ app_title }}{% endblock %} {% block content %} <div class="container-fluid">  <div class="row mb-4"> <div class="col-12"> <div class="card card-modern"> <div class="card-header-modern"> <div class="row align-items-center"> <div class="col"> <h2 class="mb-0"> <i class="fas fa-user-edit me-2"></i> تعديل العميل: {{ client.full_name }} </h2> <p class="mb-0 mt-2 opacity-75">معرف العميل: {{ client.client_id }}</p> </div> <div class="col-auto"> <a href="{{ url_for('clients_list') }}" class="btn btn-outline-light"> <i class="fas fa-arrow-right me-2"></i>العودة للقائمة </a> </div> </div> </div> </div> </div> </div>  <div class="row justify-content-center"> <div class="col-lg-10"> <div class="card card-modern"> <div class="card-body p-4"> <form method="POST" action="{{ url_for('edit_client', client_id=client.client_id) }}" id="editClientForm"> <div class="row">  <div class="col-12 mb-4"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-info-circle me-2"></i> المعلومات الأساسية </h5> </div>  <div class="col-lg-6 mb-3"> <label for="client_id" class="form-label required"> <i class="fas fa-id-card me-1"></i> معرف العميل </label> <input type="text" class="form-control" id="client_id" name="client_id" value="{{ client.client_id }}" required placeholder="أدخل معرف العميل الفريد"> <div class="form-text">معرف فريد للعميل (مطلوب)</div> </div>  <div class="col-lg-6 mb-3"> <label for="full_name" class="form-label required"> <i class="fas fa-user me-1"></i> الاسم الكامل </label> <input type="text" class="form-control" id="full_name" name="full_name" value="{{ client.full_name }}" required placeholder="أدخل الاسم الكامل للعميل"> <div class="form-text">الاسم الكامل للعميل (مطلوب)</div> </div>  <div class="col-lg-6 mb-3"> <label for="whatsapp_number" class="form-label"> <i class="fab fa-whatsapp me-1"></i> رقم الواتساب </label> <input type="tel" class="form-control" id="whatsapp_number" name="whatsapp_number" value="{{ client.whatsapp_number or '' }}" placeholder="مثال: +216XXXXXXXX"> <div class="form-text">رقم الواتساب لإرسال الإشعارات</div> </div>  <div class="col-lg-6 mb-3"> <label for="nationality" class="form-label"> <i class="fas fa-globe me-1"></i> الجنسية </label> <select class="form-select" id="nationality" name="nationality"> <option value="">اختر الجنسية</option> {% for nationality in nationalities %} <option value="{{ nationality }}" {% if client.nationality == nationality %}selected{% endif %}> {{ nationality }} </option> {% endfor %} </select> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-passport me-2"></i> معلومات جواز السفر </h5> </div>  <div class="col-lg-6 mb-3"> <label for="passport_number" class="form-label"> <i class="fas fa-passport me-1"></i> رقم جواز السفر </label> <input type="text" class="form-control" id="passport_number" name="passport_number" value="{{ client.passport_number or '' }}" placeholder="أدخل رقم جواز السفر"> </div>  <div class="col-lg-6 mb-3"> <label for="passport_status" class="form-label"> <i class="fas fa-check-circle me-1"></i> حالة جواز السفر </label> <select class="form-select" id="passport_status" name="passport_status"> <option value="">اختر حالة الجواز</option> {% for status in passport_statuses %} <option value="{{ status }}" {% if client.passport_status == status %}selected{% endif %}> {{ status }} </option> {% endfor %} </select> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-calendar me-2"></i> التواريخ المهمة </h5> </div>  <div class="col-lg-6 mb-3"> <label for="application_date" class="form-label"> <i class="fas fa-calendar-plus me-1"></i> تاريخ التقديم </label> <input type="date" class="form-control" id="application_date" name="application_date" value="{{ client.application_date or '' }}"> <div class="form-text">تاريخ تقديم طلب التأشيرة</div> </div>  <div class="col-lg-6 mb-3"> <label for="receipt_date" class="form-label"> <i class="fas fa-calendar-check me-1"></i> تاريخ استلام للسفارة </label> <input type="date" class="form-control" id="receipt_date" name="receipt_date" value="{{ client.receipt_date or '' }}"> <div class="form-text">تاريخ استلام للسفارة من العميل</div> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-cogs me-2"></i> معلومات المعالجة </h5> </div>  <div class="col-lg-6 mb-3"> <label for="visa_status" class="form-label"> <i class="fas fa-tasks me-1"></i> حالة تتبع التأشيرة </label> <select class="form-select" id="visa_status" name="visa_status"> {% for status in visa_statuses %} <option value="{{ status }}" {% if client.visa_status == status %}selected{% endif %}> {{ status }} </option> {% endfor %} </select> <div class="form-text">الحالة الحالية لطلب التأشيرة</div> <div id="statusChangeAlert" class="alert alert-info mt-2" style="display: none;"> <i class="fas fa-info-circle me-2"></i> سيتم إرسال إشعار واتساب عند تغيير الحالة </div> </div>  <div class="col-lg-6 mb-3"> <label for="responsible_employee" class="form-label"> <i class="fas fa-user-tie me-1"></i> الموظف المسؤول </label> <select class="form-select" id="responsible_employee" name="responsible_employee"> <option value="">اختر الموظف المسؤول</option> {% for employee in employees %} <option value="{{ employee }}" {% if client.responsible_employee == employee %}selected{% endif %}> {{ employee }} </option> {% endfor %} </select> </div>  <div class="col-lg-12 mb-3"> <label for="processed_by" class="form-label"> <i class="fas fa-user-check me-1"></i> من طرف </label> <input type="text" class="form-control" id="processed_by" name="processed_by" value="{{ client.processed_by or '' }}" placeholder="اسم الشخص الذي عالج الطلب"> </div> </div> <div class="row">  <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-sticky-note me-2"></i> معلومات إضافية </h5> </div>  <div class="col-lg-12 mb-3"> <label for="summary" class="form-label"> <i class="fas fa-file-alt me-1"></i> الخلاصة </label> <textarea class="form-control" id="summary" name="summary" rows="3" placeholder="ملخص موجز عن حالة العميل والطلب">{{ client.summary or '' }}</textarea> </div>  <div class="col-lg-12 mb-3"> <label for="notes" class="form-label"> <i class="fas fa-comment me-1"></i> ملاحظات </label> <textarea class="form-control" id="notes" name="notes" rows="4" placeholder="أي ملاحظات إضافية أو تفاصيل مهمة">{{ client.notes or '' }}</textarea> </div> </div>  <div class="row"> <div class="col-12 mb-4 mt-3"> <h5 class="text-primary border-bottom pb-2"> <i class="fas fa-history me-2"></i> معلومات النظام </h5> </div> <div class="col-lg-6 mb-3"> <label class="form-label"> <i class="fas fa-calendar-plus me-1"></i> تاريخ الإضافة </label> <input type="text" class="form-control" readonly value="{{ client.created_at[:19] if client.created_at else 'غير محدد' }}"> </div> <div class="col-lg-6 mb-3"> <label class="form-label"> <i class="fas fa-calendar-edit me-1"></i> آخر تحديث </label> <input type="text" class="form-control" readonly value="{{ client.updated_at[:19] if client.updated_at else 'غير محدد' }}"> </div> </div>  <div class="row mt-4"> <div class="col-12"> <div class="d-flex justify-content-between"> <div> {% if client.whatsapp_number %} <button type="button" class="btn btn-success-custom" onclick="sendWhatsAppNotification()"> <i class="fab fa-whatsapp me-2"></i>إرسال إشعار واتساب </button> {% endif %} </div> <div class="d-flex gap-3"> <a href="{{ url_for('clients_list') }}" class="btn btn-outline-secondary btn-lg"> <i class="fas fa-times me-2"></i>إلغاء </a> <button type="reset" class="btn btn-outline-warning btn-lg"> <i class="fas fa-undo me-2"></i>إعادة تعيين </button> <button type="submit" class="btn btn-primary-custom btn-lg"> <i class="fas fa-save me-2"></i>حفظ التغييرات </button> </div> </div> </div> </div> </form> </div> </div> </div> </div> </div> {% endblock %} {% block extra_css %} <style> .required::after { content: " *"; color: #dc3545; font-weight: bold; } .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(31, 83, 141, 0.25); } .form-text { font-size: 0.875rem; color: #6c757d; } .border-bottom { border-bottom: 2px solid #e9ecef !important; } .form-control[readonly] { background-color: #f8f9fa; border-color: #e9ecef; } </style> {% endblock %} {% block extra_js %} <script> const originalStatus = '{{ client.visa_status }}'; // Form validation document.getElementById('editClientForm').addEventListener('submit', function(e) { const clientId = document.getElementById('client_id').value.trim(); const fullName = document.getElementById('full_name').value.trim(); if (!clientId) { e.preventDefault(); alert('يرجى إدخال معرف العميل'); document.getElementById('client_id').focus(); return; } if (!fullName) { e.preventDefault(); alert('يرجى إدخال الاسم الكامل'); document.getElementById('full_name').focus(); return; } // Show loading showLoading(); }); // Monitor status changes document.getElementById('visa_status').addEventListener('change', function() { const statusAlert = document.getElementById('statusChangeAlert'); const whatsappNumber = document.getElementById('whatsapp_number').value; if (this.value !== originalStatus && whatsappNumber) { statusAlert.style.display = 'block'; } else { statusAlert.style.display = 'none'; } }); // Phone number formatting document.getElementById('whatsapp_number').addEventListener('input', function() { let value = this.value.replace(/\D/g, ''); // Remove non-digits // Add country code if not present if (value.length > 0 && !value.startsWith('216') && !value.startsWith('218')) { if (value.startsWith('0')) { value = '216' + value.substring(1); } else if (value.length === 8) { value = '216' + value; } } this.value = value; }); // Send WhatsApp notification function sendWhatsAppNotification() { const clientId = '{{ client.client_id }}'; const currentStatus = document.getElementById('visa_status').value; showLoading(); fetch(`/api/client/${clientId}/status`, { method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ status: currentStatus }) }) .then(response => response.json()) .then(data => { hideLoading(); if (data.success) { alert('تم إرسال إشعار الواتساب بنجاح! ✅'); } else { alert('خطأ في إرسال الإشعار: ' + data.message); } }) .catch(error => { hideLoading(); alert('خطأ في الاتصال: ' + error.message); }); } // Confirm navigation away with unsaved changes let formChanged = false; document.getElementById('editClientForm').addEventListener('input', function() { formChanged = true; }); window.addEventListener('beforeunload', function(e) { if (formChanged) { e.preventDefault(); e.returnValue = 'لديك تغييرات غير محفوظة. هل تريد المغادرة؟'; } }); // Reset form changed flag on submit document.getElementById('editClientForm').addEventListener('submit', function() { formChanged = false; }); </script> {% endblock %}