{% extends "base.html" %}

{% block title %}استيراد Excel - {{ app_title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-header-modern">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="mb-0">
                                <i class="fas fa-file-excel me-2"></i>
                                استيراد العملاء من Excel
                            </h2>
                            <p class="mb-0 mt-2 opacity-75">استيراد قائمة العملاء من ملف Excel</p>
                        </div>
                        <div class="col-auto">
                            <a href="{{ url_for('clients_list') }}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-right me-2"></i>العودة للقائمة
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-body">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        تعليمات الاستيراد
                    </h5>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <h6 class="text-secondary mb-3">تنسيق الملف المطلوب:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    ملف Excel (.xlsx أو .xls)
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    الصف الأول يحتوي على أسماء الأعمدة
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    حد أقصى 1000 عميل في الملف الواحد
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    حجم الملف أقل من 16 ميجابايت
                                </li>
                            </ul>
                        </div>
                        
                        <div class="col-lg-6">
                            <h6 class="text-secondary mb-3">الأعمدة المطلوبة:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead class="table-light">
                                        <tr>
                                            <th>اسم العمود</th>
                                            <th>مطلوب</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>معرف العميل</td>
                                            <td><span class="badge bg-danger">مطلوب</span></td>
                                        </tr>
                                        <tr>
                                            <td>الاسم الكامل</td>
                                            <td><span class="badge bg-danger">مطلوب</span></td>
                                        </tr>
                                        <tr>
                                            <td>رقم الواتساب</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>تاريخ التقديم</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>تاريخ استلام للسفارة</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>رقم جواز السفر</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>حالة جواز السفر</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>الجنسية</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>حالة تتبع التأشيرة</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>من طرف</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>الخلاصة</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>ملاحظة</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                        <tr>
                                            <td>اختيار الموظف مسؤول</td>
                                            <td><span class="badge bg-secondary">اختياري</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>تنبيه:</strong> سيتم تجاهل العملاء الذين لديهم معرف مكرر في النظام.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Upload Form -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card card-modern">
                <div class="card-header-modern">
                    <h5 class="mb-0">
                        <i class="fas fa-upload me-2"></i>
                        رفع ملف Excel
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="importForm">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-content text-center py-5">
                                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                        <h5 class="text-primary mb-3">اسحب وأفلت ملف Excel هنا</h5>
                                        <p class="text-muted mb-3">أو انقر لاختيار الملف</p>
                                        <input type="file" class="form-control" id="excel_file" name="excel_file" 
                                               accept=".xlsx,.xls" required style="display: none;">
                                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('excel_file').click()">
                                            <i class="fas fa-folder-open me-2"></i>اختيار ملف
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="fileInfo" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file-excel me-2"></i>
                                                <span id="fileName"></span>
                                                <small class="text-muted ms-2">(<span id="fileSize"></span>)</small>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            الملفات المدعومة: .xlsx, .xls (حد أقصى 16 ميجابايت)
                                        </small>
                                    </div>
                                    <div>
                                        <a href="{{ url_for('clients_list') }}" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-times me-2"></i>إلغاء
                                        </a>
                                        <button type="submit" class="btn btn-success-custom" id="importBtn" disabled>
                                            <i class="fas fa-upload me-2"></i>استيراد البيانات
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Specific File -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card card-modern border-warning">
                <div class="card-body text-center">
                    <h6 class="text-warning mb-3">
                        <i class="fas fa-star me-2"></i>
                        استيراد ملف العملاء الخاص
                    </h6>
                    <p class="text-muted mb-3">استيراد جميع بيانات العملاء من ملف "قائمة الزبائن معرض_أكتوبر2025 (21).xlsx" بدون أي تصفية أو تعديل</p>
                    <button class="btn btn-warning" onclick="importSpecificFile()" id="importSpecificBtn">
                        <i class="fas fa-magic me-2"></i>استيراد الملف الخاص (842 عميل)
                    </button>
                    <div id="specificImportProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                 role="progressbar" style="width: 0%" id="specificProgress"></div>
                        </div>
                        <p class="mt-2 mb-0" id="specificStatus">جاري الاستيراد...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sample Template Download -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-body text-center">
                    <h6 class="text-secondary mb-3">
                        <i class="fas fa-download me-2"></i>
                        تحميل نموذج Excel
                    </h6>
                    <p class="text-muted mb-3">قم بتحميل نموذج Excel فارغ مع الأعمدة المطلوبة</p>
                    <button class="btn btn-outline-primary" onclick="downloadTemplate()">
                        <i class="fas fa-download me-2"></i>تحميل النموذج
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div class="modal fade" id="importProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog fa-spin me-2"></i>
                    جاري الاستيراد...
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="importProgress"></div>
                </div>
                <p id="importStatus">جاري معالجة الملف...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.upload-area {
    border: 3px dashed #dee2e6;
    border-radius: 15px;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: var(--primary-color);
    background: rgba(31, 83, 141, 0.05);
}

.upload-area.dragover {
    border-color: var(--success-color);
    background: rgba(40, 167, 69, 0.1);
    transform: scale(1.02);
}

.upload-content {
    pointer-events: none;
}

.table-sm th, .table-sm td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

.progress {
    height: 20px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('excel_file');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const importBtn = document.getElementById('importBtn');
const importForm = document.getElementById('importForm');

// Drag and drop functionality
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

uploadArea.addEventListener('click', function() {
    fileInput.click();
});

fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        handleFile(this.files[0]);
    }
});

function handleFile(file) {
    // Validate file type
    const allowedTypes = ['.xlsx', '.xls'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(fileExtension)) {
        alert('نوع الملف غير مدعوم. يرجى اختيار ملف Excel (.xlsx أو .xls)');
        return;
    }
    
    // Validate file size (16MB)
    const maxSize = 16 * 1024 * 1024;
    if (file.size > maxSize) {
        alert('حجم الملف كبير جداً. الحد الأقصى 16 ميجابايت');
        return;
    }
    
    // Update UI
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileInfo.style.display = 'block';
    importBtn.disabled = false;
    
    // Set file to input
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;
}

function clearFile() {
    fileInput.value = '';
    fileInfo.style.display = 'none';
    importBtn.disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Form submission with progress
importForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!fileInput.files.length) {
        alert('يرجى اختيار ملف Excel');
        return;
    }
    
    // Show progress modal
    const progressModal = new bootstrap.Modal(document.getElementById('importProgressModal'));
    progressModal.show();
    
    // Simulate progress (since we can't track real progress easily)
    let progress = 0;
    const progressBar = document.getElementById('importProgress');
    const statusText = document.getElementById('importStatus');
    
    const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        
        if (progress < 30) {
            statusText.textContent = 'جاري قراءة الملف...';
        } else if (progress < 60) {
            statusText.textContent = 'جاري معالجة البيانات...';
        } else {
            statusText.textContent = 'جاري حفظ العملاء...';
        }
    }, 200);
    
    // Submit form
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        statusText.textContent = 'تم الانتهاء!';
        
        setTimeout(() => {
            progressModal.hide();
            if (response.ok) {
                window.location.href = '{{ url_for("clients_list") }}';
            } else {
                response.text().then(text => {
                    alert('خطأ في الاستيراد: ' + text);
                });
            }
        }, 1000);
    })
    .catch(error => {
        clearInterval(progressInterval);
        progressModal.hide();
        alert('خطأ في الاستيراد: ' + error.message);
    });
});

// Download template function
function downloadTemplate() {
    // Create a simple Excel template
    const headers = [
        'معرف العميل',
        'الاسم الكامل', 
        'رقم الواتساب',
        'تاريخ التقديم',
        'تاريخ استلام للسفارة',
        'رقم جواز السفر',
        'حالة جواز السفر',
        'الجنسية',
        'حالة تتبع التأشيرة',
        'من طرف',
        'الخلاصة',
        'ملاحظة',
        'اختيار الموظف مسؤول'
    ];
    
    // Create sample data
    const sampleData = [
        [
            'CLIENT_001',
            'أحمد محمد علي',
            '21612345678',
            '2024-01-15',
            '2024-01-10',
            'A1234567',
            'موجود',
            'تونسي',
            'التقديم',
            'موظف الاستقبال',
            'طلب تأشيرة سياحية',
            'عميل جديد',
            'اميرة'
        ]
    ];
    
    // Create workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'العملاء');
    
    // Download file
    XLSX.writeFile(wb, 'نموذج_استيراد_العملاء.xlsx');
}

// Import specific file function
function importSpecificFile() {
    const importBtn = document.getElementById('importSpecificBtn');
    const progressDiv = document.getElementById('specificImportProgress');
    const progressBar = document.getElementById('specificProgress');
    const statusText = document.getElementById('specificStatus');
    
    // Confirm import
    if (!confirm('هل أنت متأكد من استيراد جميع بيانات العملاء (842 عميل) من الملف الخاص؟\nسيتم استيراد جميع البيانات بدون أي تصفية أو تعديل.')) {
        return;
    }
    
    // Disable button and show progress
    importBtn.disabled = true;
    importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الاستيراد...';
    progressDiv.style.display = 'block';
    
    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        
        progressBar.style.width = progress + '%';
        
        if (progress < 20) {
            statusText.textContent = 'جاري قراءة الملف الخاص...';
        } else if (progress < 40) {
            statusText.textContent = 'جاري معالجة البيانات (842 عميل)...';
        } else if (progress < 70) {
            statusText.textContent = 'جاري حفظ العملاء في قاعدة البيانات...';
        } else {
            statusText.textContent = 'جاري إنهاء العملية...';
        }
    }, 300);
    
    // Make API call
    fetch('/import-excel-raw', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        
        if (data.success) {
            statusText.textContent = `تم الانتهاء! تم استيراد ${data.success_count} عميل بنجاح`;
            progressBar.classList.remove('bg-warning');
            progressBar.classList.add('bg-success');
            
            // Show success message
            setTimeout(() => {
                alert(`تم استيراد البيانات بنجاح!\n\nالإجمالي: ${data.total_rows} سطر\nنجح: ${data.success_count} عميل\nفشل: ${data.error_count} عميل\n\nسيتم توجيهك إلى قائمة العملاء.`);
                window.location.href = '{{ url_for("clients_list") }}';
            }, 2000);
        } else {
            statusText.textContent = 'فشل في الاستيراد!';
            progressBar.classList.remove('bg-warning');
            progressBar.classList.add('bg-danger');
            
            alert('خطأ في الاستيراد: ' + data.error);
            
            // Reset button
            setTimeout(() => {
                importBtn.disabled = false;
                importBtn.innerHTML = '<i class="fas fa-magic me-2"></i>استيراد الملف الخاص (842 عميل)';
                progressDiv.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.classList.remove('bg-danger');
                progressBar.classList.add('bg-warning');
            }, 3000);
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        progressBar.classList.remove('bg-warning');
        progressBar.classList.add('bg-danger');
        statusText.textContent = 'خطأ في الاتصال!';
        
        alert('خطأ في الاستيراد: ' + error.message);
        
        // Reset button
        setTimeout(() => {
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-magic me-2"></i>استيراد الملف الخاص (842 عميل)';
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.classList.remove('bg-danger');
            progressBar.classList.add('bg-warning');
        }, 3000);
    });
}
</script>

<!-- SheetJS for Excel handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
{% endblock %}