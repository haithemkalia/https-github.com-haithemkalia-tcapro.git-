{% extends "base.html" %}
{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - {{ app_title }}{% endblock %}
{% block content %}
<div class="container-fluid">
 <div class="row mb-4">
 <div class="col-12">
  <div class="card card-modern">
  <div class="card-header-modern">
   <div class="row align-items-center">
   <div class="col">
    <h2 class="mb-0">
    <i class="fas fa-users me-2"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    </h2>
    <p class="mb-0 mt-2 opacity-75">Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
   </div>
   <div class="col-auto">
    <a href="{{ url_for('add_client') }}" class="btn btn-success-custom">
    <i class="fas fa-plus me-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
    </a>
   </div>
   </div>
  </div>
  </div>
 </div>
 </div>

 <div class="row mb-4">
 <div class="col-12">
  <div class="card card-modern">
  <div class="card-body">
   <form method="GET" action="{{ url_for('clients_list') }}" class="row g-3">
   <div class="col-lg-4 col-md-6">
    <label for="search" class="form-label">
    <i class="fas fa-search me-1"></i>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙÙˆØ±ÙŠ
    </label>
    <input type="text" class="form-control" id="search" name="search" 
      value="{{ search_term }}" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
   </div>
   
   <div class="col-lg-2 col-md-6">
    <label for="status" class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©</label>
    <select class="form-select" id="status" name="status">
    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
    {% for status in visa_statuses %}
    <option value="{{ status }}" {% if status_filter == status %}selected{% endif %}>
     {{ status }}
    </option>
    {% endfor %}
    </select>
   </div>
   
   <div class="col-lg-2 col-md-6">
    <label for="nationality" class="form-label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label>
    <select class="form-select" id="nationality" name="nationality">
    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù†Ø³ÙŠØ§Øª</option>
    {% for nationality in nationalities %}
    <option value="{{ nationality }}" {% if nationality_filter == nationality %}selected{% endif %}>
     {{ nationality }}
    </option>
    {% endfor %}
    </select>
   </div>
   
   <div class="col-lg-2 col-md-6">
    <label for="employee" class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
    <select class="form-select" id="employee" name="employee">
    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
    {% for employee in employees %}
    <option value="{{ employee }}" {% if employee_filter == employee %}selected{% endif %}>
     {{ employee }}
    </option>
    {% endfor %}
    </select>
   </div>
   
   <div class="col-lg-2 col-md-6 d-flex align-items-end">
    <button type="submit" class="btn btn-primary-custom w-100">
    <i class="fas fa-search me-1"></i>Ø¨Ø­Ø«
    </button>
   </div>
   
   <div class="col-lg-2 col-md-6 d-flex align-items-end">
    <a href="{{ url_for('clients_list', per_page='all') }}" class="btn btn-info-custom w-100">
    <i class="fas fa-list me-1"></i>Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
    </a>
   </div>
   
   <div class="col-lg-2 col-md-6 d-flex align-items-end">
    <button type="button" class="btn btn-success-custom w-100" onclick="exportToExcel()">
    <i class="fas fa-file-excel me-1"></i>ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„
    </button>
   </div>
   </div>
   </form>
  </div>
  </div>
 </div>
 </div>

 <div class="row">
 <div class="col-12">
  <div class="card card-modern">
  <div class="card-body">
   {% if clients and clients|length > 0 %}
   <div class="table-responsive">
    <table class="table table-hover">
    <thead class="table-dark">
     <tr>
     <th>Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
     <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
     <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th>
     <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</th>
     <th>ØªØ§Ø±ÙŠØ® Ø§Ø³ØªÙ„Ø§Ù… Ù„Ù„Ø³ÙØ§Ø±Ø©</th>
     <th>Ø±Ù‚Ù… Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</th>
     <th>Ø­Ø§Ù„Ø© Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</th>
     <th>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</th>
     <th>Ø­Ø§Ù„Ø© ØªØªØ¨Ø¹ Ø§Ù„ØªØ£Ø´ÙŠØ±Ø©</th>
     <th>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¤ÙˆÙ„</th>
     <th>Ù…Ù† Ø·Ø±Ù</th>
     <th>Ø§Ù„Ø®Ù„Ø§ØµØ©</th>
     <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
     <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
     </tr>
    </thead>
    <tbody>
     {% for client in clients %}
     <tr>
     <td>{{ client.get('client_id', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>{{ client.get('full_name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>{{ client.get('whatsapp_number', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>
      <div class="inline-edit-container" data-field="application_date" data-client-id="{{ client.get('client_id', '') }}">
       <div class="inline-edit-display">
        <span class="field-value">{{ client.get('file_date', client.get('application_date', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')) }}</span>
        <i class="fas fa-edit edit-icon"></i>
       </div>
       <input type="date" class="inline-edit-input form-control form-control-sm" style="display: none;" value="{{ client.get('file_date', client.get('application_date', '')) }}">
      </div>
     </td>
     <td>
      <div class="inline-edit-container" data-field="transaction_date" data-client-id="{{ client.get('client_id', '') }}">
       <div class="inline-edit-display">
        <span class="field-value">{{ client.get('reception_date', client.get('transaction_date', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')) }}</span>
        <i class="fas fa-edit edit-icon"></i>
       </div>
       <input type="date" class="inline-edit-input form-control form-control-sm" style="display: none;" value="{{ client.get('reception_date', client.get('transaction_date', '')) }}">
      </div>
     </td>
     <td>{{ client.get('passport_number', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>{{ client.get('passport_status', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>{{ client.get('nationality', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>
      <div class="inline-edit-container" data-field="visa_status" data-client-id="{{ client.get('client_id', '') }}">
       <div class="inline-edit-display">
        <span class="field-value">{{ client.get('visa_status', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</span>
        <i class="fas fa-edit edit-icon"></i>
       </div>
       <select class="inline-edit-input form-select form-select-sm" style="display: none;">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
        {% for status in visa_statuses %}
        <option value="{{ status }}" {% if client.get('visa_status', '') == status %}selected{% endif %}>{{ status }}</option>
        {% endfor %}
       </select>
      </div>
     </td>
     <td>
      <div class="inline-edit-container" data-field="responsible_employee" data-client-id="{{ client.get('client_id', '') }}">
       <div class="inline-edit-display">
        <span class="field-value">{{ client.get('responsible_employee', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</span>
        <i class="fas fa-edit edit-icon"></i>
       </div>
       <select class="inline-edit-input form-select form-select-sm" style="display: none;">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
        {% for employee in employees %}
        <option value="{{ employee }}" {% if client.get('responsible_employee', '') == employee %}selected{% endif %}>{{ employee }}</option>
        {% endfor %}
       </select>
      </div>
     </td>
     <td>{{ client.get('processed_by', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>{{ client.get('summary', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>{{ client.get('notes', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') }}</td>
     <td>
      <div class="btn-group" role="group">
      <a href="{{ url_for('edit_client', client_id=client.get('client_id', '')) }}" 
        class="btn btn-sm btn-outline-primary" title="ØªØ¹Ø¯ÙŠÙ„">
       <i class="fas fa-edit"></i>
      </a>
      <button type="button" class="btn btn-sm btn-outline-success" 
       onclick="sendWhatsAppTest('{{ client.get('client_id', '') }}')" 
       title="Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨">
       <i class="fab fa-whatsapp"></i>
      </button>
      <button type="button" class="btn btn-sm btn-outline-danger" 
       onclick="deleteClient('{{ client.get('client_id', '') }}')" 
       title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ£ÙƒÙŠØ¯"
       style="transition: all 0.3s ease;">
       <i class="fas fa-trash"></i> Ø­Ø°Ù
      </button>
      </div>
     </td>
     </tr>
     {% endfor %}
    </tbody>
    </table>
   </div>
   {% else %}
   <div class="text-center py-5">
    <i class="fas fa-users fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h4>
    <p class="text-muted">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</p>
   </div>
   {% endif %}
  </div>
  </div>
  </div>
 </div>
</div>

<!-- Pagination -->
{% if pagination and pagination.total_pages > 1 %}
<div class="row mt-4">
 <div class="col-12">
  <div class="card card-modern">
   <div class="card-body">
    <div class="row align-items-center">
     <div class="col-md-6">
      <p class="mb-0 text-muted">
       Ø¹Ø±Ø¶ {{ (pagination.page - 1) * pagination.per_page + 1 }} Ø¥Ù„Ù‰ 
       {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page <= pagination.total else pagination.total }} 
       Ù…Ù† Ø£ØµÙ„ {{ pagination.total }} Ø¹Ù…ÙŠÙ„
      </p>
     </div>
     <div class="col-md-6">
      <nav aria-label="Pagination">
       <ul class="pagination justify-content-end mb-0">
        <!-- Page prÃ©cÃ©dente -->
        {% if pagination.has_prev %}
        <li class="page-item">
         <a class="page-link" href="{{ url_for('clients_list', page=pagination.prev_num, per_page=pagination.per_page, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}">
          <i class="fas fa-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
         </a>
        </li>
        {% else %}
        <li class="page-item disabled">
         <span class="page-link">
          <i class="fas fa-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
         </span>
        </li>
        {% endif %}
        
        <!-- Pages numÃ©rotÃ©es -->
        {% set start_page = [1, pagination.page - 2]|max %}
        {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
         <a class="page-link" href="{{ url_for('clients_list', page=1, per_page=pagination.per_page, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
         <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}
        
        {% for page_num in range(start_page, end_page + 1) %}
        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
         <a class="page-link" href="{{ url_for('clients_list', page=page_num, per_page=pagination.per_page, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}">{{ page_num }}</a>
        </li>
        {% endfor %}
        
        {% if end_page < pagination.total_pages %}
        {% if end_page < pagination.total_pages - 1 %}
        <li class="page-item disabled">
         <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
         <a class="page-link" href="{{ url_for('clients_list', page=pagination.total_pages, per_page=pagination.per_page, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}">{{ pagination.total_pages }}</a>
        </li>
        {% endif %}
        
        <!-- Page suivante -->
        {% if pagination.has_next %}
        <li class="page-item">
         <a class="page-link" href="{{ url_for('clients_list', page=pagination.next_num, per_page=pagination.per_page, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}">
          Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-chevron-left"></i>
         </a>
        </li>
        {% else %}
        <li class="page-item disabled">
         <span class="page-link">
          Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-chevron-left"></i>
         </span>
        </li>
        {% endif %}
       </ul>
      </nav>
     </div>
    </div>
    
    <!-- Options de pagination -->
    <div class="row mt-3">
     <div class="col-12">
      <div class="btn-group" role="group">
       <a href="{{ url_for('clients_list', per_page=25, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}" 
          class="btn btn-sm {% if pagination.per_page == 25 %}btn-primary{% else %}btn-outline-primary{% endif %}">25</a>
       <a href="{{ url_for('clients_list', per_page=50, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}" 
          class="btn btn-sm {% if pagination.per_page == 50 %}btn-primary{% else %}btn-outline-primary{% endif %}">50</a>
       <a href="{{ url_for('clients_list', per_page=100, search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}" 
          class="btn btn-sm {% if pagination.per_page == 100 %}btn-primary{% else %}btn-outline-primary{% endif %}">100</a>
       <a href="{{ url_for('clients_list', per_page='all', search=search_term, status=status_filter, nationality=nationality_filter, employee=employee_filter) }}" 
          class="btn btn-sm {% if pagination.per_page >= 10000 %}btn-success{% else %}btn-outline-success{% endif %}">
        <i class="fas fa-list"></i> Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„
       </a>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
</div>
{% endif %}

<script>
// JavaScript pour l'Ã©dition en ligne
document.addEventListener('DOMContentLoaded', function() {
 initializeInlineEditing();
});

function initializeInlineEditing() {
 const containers = document.querySelectorAll('.inline-edit-container');
 containers.forEach(container => {
 const display = container.querySelector('.inline-edit-display');
 const input = container.querySelector('.inline-edit-input');
 const editIcon = container.querySelector('.edit-icon');
 
 if (display && input && editIcon) {
  display.addEventListener('click', function(e) {
  e.stopPropagation();
  activateInlineEdit(container);
  });
  
  editIcon.addEventListener('click', function(e) {
  e.stopPropagation();
  activateInlineEdit(container);
  });
  
  if (input.tagName === 'SELECT') {
  input.addEventListener('change', function() {
   saveInlineEdit(container);
  });
  } else if (input.tagName === 'INPUT') {
  input.addEventListener('blur', function() {
   saveInlineEdit(container);
  });
  input.addEventListener('keydown', function(e) {
   if (e.key === 'Enter') {
   saveInlineEdit(container);
   } else if (e.key === 'Escape') {
   cancelInlineEdit(container);
   }
  });
  }
 }
 });
}

function activateInlineEdit(container) {
 const display = container.querySelector('.inline-edit-display');
 const input = container.querySelector('.inline-edit-input');
 
 if (display && input) {
 display.style.display = 'none';
 input.style.display = 'block';
 input.focus();
 }
}

function saveInlineEdit(container) {
 const field = container.dataset.field;
 const clientId = container.dataset.clientId;
 const input = container.querySelector('.inline-edit-input');
 const value = input.value;
 
 if (!value && input.tagName !== 'SELECT') {
 cancelInlineEdit(container);
 return;
 }
 
 // Afficher le loading
 showInlineEditLoading(container);
 
 // Envoyer la requÃªte
 fetch(`/api/client/${clientId}/update-field`, {
 method: 'POST',
 headers: {
  'Content-Type': 'application/json',
 },
 body: JSON.stringify({
  field: field,
  value: value
 })
 })
 .then(response => response.json())
 .then(data => {
 if (data.success) {
  updateInlineEditDisplay(container, value);
  showInlineEditMessage(container, 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­', 'success');
 } else {
  showInlineEditMessage(container, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + data.message, 'error');
  cancelInlineEdit(container);
 }
 })
 .catch(error => {
 showInlineEditMessage(container, 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
 cancelInlineEdit(container);
 });
}

function cancelInlineEdit(container) {
 const display = container.querySelector('.inline-edit-display');
 const input = container.querySelector('.inline-edit-input');
 
 if (display && input) {
 display.style.display = 'block';
 input.style.display = 'none';
 }
}

function updateInlineEditDisplay(container, value) {
 const fieldValue = container.querySelector('.field-value');
 if (fieldValue) {
 fieldValue.textContent = value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
 }
}

function showInlineEditLoading(container) {
 const display = container.querySelector('.inline-edit-display');
 if (display) {
 display.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
 }
}

function showInlineEditMessage(container, message, type) {
 const display = container.querySelector('.inline-edit-display');
 if (display) {
 const className = type === 'success' ? 'text-success' : 'text-danger';
 display.innerHTML = `<span class="${className}">${message}</span>`;
 
 setTimeout(() => {
  const fieldValue = container.querySelector('.field-value');
  if (fieldValue) {
  display.innerHTML = fieldValue.outerHTML + '<i class="fas fa-edit edit-icon"></i>';
  }
 }, 2000);
 }
}

// Fonction pour supprimer un client avec confirmation avancÃ©e
function deleteClient(clientId) {
 // RÃ©cupÃ©rer les informations du client pour la confirmation
 const row = event.target.closest('tr');
 const clientName = row.querySelector('td:nth-child(2)').textContent.trim();
 const clientPhone = row.querySelector('td:nth-child(3)').textContent.trim();
 
 // Message de confirmation dÃ©taillÃ©
 const confirmMessage = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ

ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:
â€¢ Ø§Ù„Ù…Ø¹Ø±Ù: ${clientId}
â€¢ Ø§Ù„Ø§Ø³Ù…: ${clientName}
â€¢ Ø§Ù„Ù‡Ø§ØªÙ: ${clientPhone}

âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!

Ø§ÙƒØªØ¨ "Ø­Ø°Ù" Ù„Ù„ØªØ£ÙƒÙŠØ¯:`;
 
 // Demander confirmation avec input
 const userInput = prompt(confirmMessage);
 
 if (userInput !== 'Ø­Ø°Ù') {
  if (userInput !== null) {
   alert('âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø°Ù - Ù„Ù… ØªÙƒØªØ¨ "Ø­Ø°Ù"');
  }
  return;
 }
 
 // Afficher le loading
 const button = event.target.closest('button');
 const originalContent = button.innerHTML;
 button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø­Ø°Ù...';
 button.disabled = true;
 
 // CrÃ©er un formulaire pour la suppression
 const form = document.createElement('form');
 form.method = 'POST';
 form.action = `/client/delete/${clientId}`;
 
 // Ajouter le formulaire au DOM et le soumettre
 document.body.appendChild(form);
 form.submit();
}

// Fonction pour envoyer un message WhatsApp de test
function sendWhatsAppTest(clientId) {
 if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) {
 return;
 }
 
 // Afficher le loading
 const button = event.target.closest('button');
 const originalContent = button.innerHTML;
 button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
 button.disabled = true;
 
 // Envoyer la requÃªte
 fetch(`/api/client/${clientId}/send-whatsapp`, {
 method: 'POST',
 headers: {
  'Content-Type': 'application/json',
 }
 })
 .then(response => response.json())
 .then(data => {
 if (data.success) {
  alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“± Ø§Ù„Ø±Ù‚Ù…: ' + data.phone_number + '\nğŸ“‹ Ø§Ù„Ø­Ø§Ù„Ø©: ' + data.status);
 } else {
  alert('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + data.message);
 }
 })
 .catch(error => {
 alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
 })
 .finally(() => {
 // Restaurer le bouton
 button.innerHTML = originalContent;
 button.disabled = false;
 });
}

// Fonction pour exporter vers Excel
function exportToExcel() {
 // RÃ©cupÃ©rer les paramÃ¨tres de recherche actuels
 const searchParams = new URLSearchParams(window.location.search);
 const search = searchParams.get('search') || '';
 const status = searchParams.get('status') || '';
 const nationality = searchParams.get('nationality') || '';
 const employee = searchParams.get('employee') || '';
 
 // Construire l'URL d'export avec les paramÃ¨tres
 let exportUrl = '/export/excel';
 const params = [];
 
 if (search) params.push(`search=${encodeURIComponent(search)}`);
 if (status) params.push(`status=${encodeURIComponent(status)}`);
 if (nationality) params.push(`nationality=${encodeURIComponent(nationality)}`);
 if (employee) params.push(`employee=${encodeURIComponent(employee)}`);
 
 if (params.length > 0) {
  exportUrl += '?' + params.join('&');
 }
 
 // Ouvrir le lien de tÃ©lÃ©chargement dans un nouvel onglet
 window.open(exportUrl, '_blank');
}
</script>
{% endblock %}